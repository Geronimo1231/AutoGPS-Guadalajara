<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestión de Vehículos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style id="app-style">
    [v-cloak] { display: none; }
    
    html, body {
      height: 100%;
    }
    
    #app {
      height: 100%;
    }
    
    .sidebar {
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      z-index: 100;
      padding-top: 60px;
      background-color: #f8f9fa;
      transition: all 0.3s;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar-link {
      padding: 10px 15px;
      display: block;
      color: #495057;
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .sidebar-link:hover, .sidebar-link.active {
      color: #0d6efd;
      background-color: rgba(13, 110, 253, 0.1);
    }
    
    .sidebar-link i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 20px;
      padding-top: 70px;
      min-height: 100%;
      background-color: #f0f2f5;
    }
    
    .navbar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1030;
      background-color: #ffffff !important;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .navbar-dark {
      background-color: #ffffff !important;
    }
    
    .navbar-dark .navbar-brand, 
    .navbar-dark .nav-link,
    .navbar-dark .navbar-toggler-icon {
      color: #212529 !important;
    }
    
    .navbar-brand {
      margin-left: 20px;
    }
    
    .vehicle-card {
      transition: transform 0.3s;
      height: 100%;
    }
    
    .vehicle-card:hover {
      transform: translateY(-5px);
      cursor: pointer;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    
    #map {
      height: calc(100vh - 140px);
      width: 100%;
      border-radius: 8px;
    }
    
    .profile-avatar {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f0f2f5;
    }
    
    .login-form {
      width: 100%;
      max-width: 400px;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .password-feedback {
      font-size: 0.8rem;
    }
    
    .password-requirement {
      margin-bottom: 5px;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 80px;
      }
      
      .sidebar-link span {
        display: none;
      }
      
      .sidebar-link i {
        margin-right: 0;
        font-size: 1.2rem;
      }
      
      .main-content {
        margin-left: 80px;
      }
    }
    
    .card {
      background-color: #ffffff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
    }
    
    .btn-secondary:hover {
      background-color: #5c636a;
      border-color: #565e64;
    }
    
    .bg-dark {
      background-color: #f8f9fa !important;
      color: #212529 !important;
    }
    
    .navbar-dark .navbar-nav .nav-link {
      color: #495057 !important;
    }
    
    .navbar-dark .navbar-nav .nav-link:hover {
      color: #0d6efd !important;
    }
    
    .dropdown-menu {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border: none;
    }
</style>
</head>
<body>
  <div id="app" v-cloak>
    <!-- Login Screen -->
    <div v-if="!isAuthenticated" class="login-container">
      <div class="login-form">
        <h2 class="text-center mb-4">Iniciar Sesión</h2>
        <div class="mb-3">
          <label for="email" class="form-label">Correo Electrónico</label>
          <input type="email" class="form-control" id="email" v-model="loginForm.email" placeholder="correo@ejemplo.com">
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Contraseña</label>
          <input type="password" class="form-control" id="password" v-model="loginForm.password">
        </div>
        <div v-if="loginError" class="alert alert-danger">{{ loginError }}</div>
        <button class="btn btn-primary w-100" @click="login" :disabled="isLoading">
          <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
          Iniciar Sesión
        </button>
        
        <!-- Nueva sección de cuentas de demostración -->
        <div class="mt-4">
          <div class="card border-info">
            <div class="card-header bg-info text-white">
              <i class="fas fa-info-circle me-2"></i>Cuentas de Demostración
            </div>
            <div class="card-body">
              <p class="card-text mb-2">Utilice cualquiera de estas cuentas para probar el sistema:</p>
              <div class="mb-2">
                <span class="badge bg-danger me-2">Administrador Global</span>
                <small><strong>Correo:</strong> globaladmin@ejemplo.com | <strong>Contraseña:</strong> Admin123!</small>
              </div>
              <div class="mb-2">
                <span class="badge bg-warning text-dark me-2">Administrador</span>
                <small><strong>Correo:</strong> admin@ejemplo.com | <strong>Contraseña:</strong> Admin123!</small>
              </div>
              <div>
                <span class="badge bg-info me-2">Usuario</span>
                <small><strong>Correo:</strong> usuario@ejemplo.com | <strong>Contraseña:</strong> User123!</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Application after login -->
    <template v-if="isAuthenticated">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="javascript:void(0)">Sistema de Gestión de Vehículos</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="javascript:void(0)" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                  <i class="fas fa-user me-2"></i>{{ currentUser.nombre }}
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="javascript:void(0)" @click="setCurrentRoute('perfil')">Mi Perfil</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="javascript:void(0)" @click="logout">Cerrar Sesión</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Sidebar -->
      <div class="sidebar bg-dark">
        <a href="javascript:void(0)" @click="setCurrentRoute('catalogo')" class="sidebar-link" :class="{ active: currentRoute === 'catalogo' }">
          <i class="fas fa-car"></i> <span>Catálogo de Vehículos</span>
        </a>
        <a href="javascript:void(0)" @click="setCurrentRoute('asignaciones')" class="sidebar-link" :class="{ active: currentRoute === 'asignaciones' }" v-if="isAdmin">
          <i class="fas fa-exchange-alt"></i> <span>Asignaciones</span>
        </a>
        <a href="javascript:void(0)" @click="setCurrentRoute('mapa')" class="sidebar-link" :class="{ active: currentRoute === 'mapa' }" v-if="isAdmin">
          <i class="fas fa-map-marker-alt"></i> <span>Mapa</span>
        </a>
        <a v-if="isAdmin" href="javascript:void(0)" @click="setCurrentRoute('usuarios')" class="sidebar-link" :class="{ active: currentRoute === 'usuarios' }">
          <i class="fas fa-users"></i> <span>Usuarios</span>
        </a>
        <a v-if="isGlobalAdmin" href="javascript:void(0)" @click="setCurrentRoute('dashboard')" class="sidebar-link" :class="{ active: currentRoute === 'dashboard' }">
          <i class="fas fa-chart-bar"></i> <span>Dashboard</span>
        </a>
        <a href="javascript:void(0)" @click="setCurrentRoute('perfil')" class="sidebar-link" :class="{ active: currentRoute === 'perfil' }">
          <i class="fas fa-user-cog"></i> <span>Perfil</span>
        </a>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Catálogo de Vehículos -->
        <div v-if="currentRoute === 'catalogo'">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Catálogo de Vehículos</h2>
            <button class="btn btn-primary" @click="openNewVehicleModal" v-if="isAdmin">
              <i class="fas fa-plus me-2"></i>Nuevo Vehículo
            </button>
          </div>
          <div class="row g-4">
            <div v-for="(vehiculo, index) in filteredVehiculos" :key="index" class="col-sm-6 col-md-4 col-lg-3">
              <div class="card vehicle-card shadow-sm" @click="openVehicleModal(vehiculo)">
                <img :src="vehiculo.imagen" class="card-img-top" alt="Vehículo" style="height: 180px; object-fit: cover;">
                <div class="card-body">
                  <h5 class="card-title">{{ vehiculo.matricula }}</h5>
                  <p class="card-text">{{ vehiculo.marca }} {{ vehiculo.modelo }} ({{ vehiculo.anio }})</p>
                  <p v-if="vehiculo.estado === 'Asignado'" class="card-text small text-muted">
                    <strong>Asignado a:</strong> {{ vehiculo.usuario }}
                  </p>
                  <div class="status-badge">
                    <span class="badge" :class="vehiculo.estado === 'Disponible' ? 'bg-success' : 'bg-warning'">
                      {{ vehiculo.estado }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Asignaciones -->
        <div v-if="currentRoute === 'asignaciones'">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Asignaciones</h2>
            <button class="btn btn-primary" @click="openNewAssignmentModal">
              <i class="fas fa-plus me-2"></i>Nueva Asignación
            </button>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Usuario</th>
                      <th>Vehículo</th>
                      <th>Matrícula</th>
                      <th>Fecha de Asignación</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(asignacion, index) in asignaciones" :key="index">
                      <td>{{ asignacion.usuario }}</td>
                      <td>{{ asignacion.vehiculo }}</td>
                      <td>{{ asignacion.matricula }}</td>
                      <td>{{ asignacion.fecha }}</td>
                      <td>
                        <button class="btn btn-sm btn-danger" @click="deleteAssignment(asignacion.id)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Mapa -->
        <div v-if="currentRoute === 'mapa'">
          <h2 class="mb-4">Mapa de Vehículos</h2>
          <div class="card">
            <div class="card-body">
              <div id="map"></div>
            </div>
          </div>
        </div>

        <!-- Usuarios (Admin only) -->
        <div v-if="currentRoute === 'usuarios' && isAdmin">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Gestión de Usuarios</h2>
            <button class="btn btn-primary" @click="openNewUserModal">
              <i class="fas fa-plus me-2"></i>Nuevo Usuario
            </button>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Apellido</th>
                      <th>Email</th>
                      <th>Teléfono</th>
                      <th>Rol</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(usuario, index) in usuarios" :key="index">
                      <td>{{ usuario.nombre }}</td>
                      <td>{{ usuario.apellido }}</td>
                      <td>{{ usuario.email }}</td>
                      <td>{{ usuario.telefono }}</td>
                      <td>
                        <span class="badge" :class="getRoleBadgeClass(usuario.rol)">
                          {{ usuario.rol }}
                        </span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-primary me-2" @click="editUser(usuario)">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" @click="deleteUser(usuario.id)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard (Global Admin only) -->
        <div v-if="currentRoute === 'dashboard' && isGlobalAdmin">
          <h2 class="mb-4">Dashboard de Marcas</h2>
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  Distribución de Vehículos por Marca
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Marca</th>
                          <th>Vehículos Disponibles</th>
                          <th>Vehículos Asignados</th>
                          <th>Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr v-for="(marca, index) in dashboardData" :key="index">
                          <td>{{ marca.nombre }}</td>
                          <td>{{ marca.disponibles }}</td>
                          <td>{{ marca.asignados }}</td>
                          <td>{{ marca.disponibles + marca.asignados }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Perfil de Usuario -->
        <div v-if="currentRoute === 'perfil'">
          <h2 class="mb-4">Mi Perfil</h2>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 text-center mb-4">
                  <img :src="currentUser.foto || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png'" 
                       alt="Foto de perfil" class="profile-avatar mb-3">
                  <div>
                    <button class="btn btn-outline-primary mt-2" @click="updateProfilePhoto">Cambiar Foto</button>
                  </div>
                </div>
                <div class="col-md-8">
                  <form @submit.prevent="updateProfile">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" v-model="profileForm.nombre">
                      </div>
                      <div class="col-md-6">
                        <label for="apellido" class="form-label">Apellido</label>
                        <input type="text" class="form-control" id="apellido" v-model="profileForm.apellido">
                      </div>
                      <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" v-model="profileForm.email" readonly>
                      </div>
                      <div class="col-md-6">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="telefono" v-model="profileForm.telefono">
                      </div>
                    </div>
                    
                    <h5 class="mt-4">Cambiar Contraseña</h5>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="currentPassword" class="form-label">Contraseña Actual</label>
                        <input type="password" class="form-control" id="currentPassword" v-model="profileForm.currentPassword">
                      </div>
                      <div class="col-md-6">
                        <label for="newPassword" class="form-label">Nueva Contraseña</label>
                        <input type="password" class="form-control" id="newPassword" v-model="profileForm.newPassword">
                      </div>
                      <div class="col-md-12">
                        <div class="password-feedback mt-2">
                          <div class="password-requirement" :class="passwordHasUppercase ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasUppercase ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos una letra mayúscula
                          </div>
                          <div class="password-requirement" :class="passwordHasLowercase ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasLowercase ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos una letra minúscula
                          </div>
                          <div class="password-requirement" :class="passwordHasNumber ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasNumber ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos un número
                          </div>
                          <div class="password-requirement" :class="passwordHasSpecial ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasSpecial ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos un carácter especial
                          </div>
                          <div class="password-requirement" :class="passwordHasMinLength ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasMinLength ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos 8 caracteres
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="mt-4">
                      <button type="submit" class="btn btn-primary" :disabled="isUpdating">
                        <span v-if="isUpdating" class="spinner-border spinner-border-sm me-2"></span>
                        Guardar Cambios
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vehicle Detail Modal -->
      <div class="modal fade" id="vehicleDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Detalle del Vehículo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" v-if="selectedVehicle">
              <div class="row">
                <div class="col-md-6">
                  <img :src="selectedVehicle.imagen" class="img-fluid rounded mb-3" alt="Vehículo">
                  <div class="row">
                    <div class="col-4 mb-3" v-for="(img, i) in selectedVehicle.imagenes || []" :key="i">
                      <img :src="img" class="img-fluid rounded" alt="Imagen adicional">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="additionalImages" class="form-label">Subir imágenes adicionales</label>
                    <input class="form-control" type="file" id="additionalImages" multiple @change="uploadVehicleImage($event, false)">
                  </div>
                  <div class="image-preview row mt-2" v-if="selectedVehicle.imagenes && selectedVehicle.imagenes.length > 0">
                    <h6>Imágenes seleccionadas:</h6>
                    <div class="col-4 mb-2" v-for="(img, i) in selectedVehicle.imagenes" :key="i">
                      <img :src="img" class="img-thumbnail" style="height: 80px; object-fit: cover;" alt="Vista previa">
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <ul class="list-group">
                    <li class="list-group-item"><strong>Matrícula:</strong> {{ selectedVehicle.matricula }}</li>
                    <li class="list-group-item"><strong>Marca:</strong> {{ selectedVehicle.marca }}</li>
                    <li class="list-group-item"><strong>Modelo:</strong> {{ selectedVehicle.modelo }}</li>
                    <li class="list-group-item"><strong>Año:</strong> {{ selectedVehicle.anio }}</li>
                    <li class="list-group-item"><strong>Color:</strong> {{ selectedVehicle.color }}</li>
                    <li class="list-group-item"><strong>Estado:</strong> 
                      <span class="badge" :class="selectedVehicle.estado === 'Disponible' ? 'bg-success' : 'bg-warning'">
                        {{ selectedVehicle.estado }}
                      </span>
                    </li>
                    <li class="list-group-item" v-if="selectedVehicle.usuario">
                      <strong>Asignado a:</strong> {{ selectedVehicle.usuario }}
                    </li>
                    <li class="list-group-item"><strong>Última actualización:</strong> {{ selectedVehicle.actualizacion }}</li>
                  </ul>
                  
                  <!-- Nueva sección de historial y comentarios -->
                  <div class="mt-4">
                    <h5>Historial de Asignaciones y Comentarios</h5>
                    <div class="card mb-3">
                      <div class="card-body">
                        <div class="mb-3" v-if="selectedVehicle.historial && selectedVehicle.historial.length > 0">
                          <ul class="list-group list-group-flush">
                            <li class="list-group-item" v-for="(item, i) in selectedVehicle.historial" :key="i">
                              <strong>{{ item.fecha }}</strong>: {{ item.accion }}
                              <div v-if="item.comentario" class="text-muted small mt-1">{{ item.comentario }}</div>
                            </li>
                          </ul>
                        </div>
                        <div v-else class="text-muted">No hay historial de asignaciones para este vehículo.</div>
                        
                        <div class="mt-3">
                          <label for="vehicleComments" class="form-label">Agregar comentario:</label>
                          <textarea class="form-control" id="vehicleComments" rows="3" 
                                    v-model="selectedVehicle.nuevoComentario" 
                                    placeholder="Escriba aquí comentarios adicionales sobre el vehículo..."></textarea>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                          <button class="btn btn-sm btn-primary" @click="saveVehicleComments">
                            <i class="fas fa-save me-1"></i> Guardar Comentarios
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- New Assignment Modal -->
      <div class="modal fade" id="newAssignmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Nueva Asignación</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="mb-3">
                  <label for="vehiculoSelect" class="form-label">Vehículo</label>
                  <select class="form-select" id="vehiculoSelect" v-model="newAssignment.vehiculoId">
                    <option value="" disabled selected>Seleccione un vehículo</option>
                    <option v-for="vehiculo in vehiculosDisponibles" :key="vehiculo.id" :value="vehiculo.id">
                      {{ vehiculo.marca }} {{ vehiculo.modelo }} - {{ vehiculo.matricula }}
                    </option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="usuarioSelect" class="form-label">Usuario</label>
                  <select class="form-select" id="usuarioSelect" v-model="newAssignment.usuarioId">
                    <option value="" disabled selected>Seleccione un usuario</option>
                    <option v-for="usuario in usuarios" :key="usuario.id" :value="usuario.id">
                      {{ usuario.nombre }} {{ usuario.apellido }}
                    </option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="fechaAsignacion" class="form-label">Fecha de Asignación</label>
                  <input type="date" class="form-control" id="fechaAsignacion" v-model="newAssignment.fecha">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" @click="createAssignment" :disabled="isLoading">
                <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                Guardar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- New/Edit User Modal -->
      <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ isEditingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="userNombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="userNombre" v-model="userForm.nombre">
                  </div>
                  <div class="col-md-6">
                    <label for="userApellido" class="form-label">Apellido</label>
                    <input type="text" class="form-control" id="userApellido" v-model="userForm.apellido">
                  </div>
                  <div class="col-md-6">
                    <label for="userEmail" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="userEmail" v-model="userForm.email" 
                           :readonly="isEditingUser && currentUser.rol !== 'Administrador Global'">
                  </div>
                  <div class="col-md-6">
                    <label for="userTelefono" class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" id="userTelefono" v-model="userForm.telefono">
                  </div>
                  <div class="col-md-6">
                    <label for="userRol" class="form-label">Rol</label>
                    <select class="form-select" id="userRol" v-model="userForm.rol" 
                            :disabled="isEditingUser && currentUser.rol !== 'Administrador Global'">
                      <option value="Usuario">Usuario</option>
                      <option value="Administrador">Administrador</option>
                      <option value="Administrador Global">Administrador Global</option>
                    </select>
                  </div>
                  <div class="col-md-6" v-if="!isEditingUser">
                    <label for="userPassword" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="userPassword" v-model="userForm.password">
                  </div>
                </div>
                
                <div v-if="!isEditingUser" class="password-feedback mt-3">
                  <div class="password-requirement" :class="userPasswordHasUppercase ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasUppercase ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos una letra mayúscula
                  </div>
                  <div class="password-requirement" :class="userPasswordHasLowercase ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasLowercase ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos una letra minúscula
                  </div>
                  <div class="password-requirement" :class="userPasswordHasNumber ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasNumber ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos un número
                  </div>
                  <div class="password-requirement" :class="userPasswordHasSpecial ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasSpecial ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos un carácter especial
                  </div>
                  <div class="password-requirement" :class="userPasswordHasMinLength ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasMinLength ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos 8 caracteres
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" @click="saveUser" :disabled="isLoading || (!isEditingUser && !isValidPassword)">
                <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                Guardar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Vehicle Form Modal -->
      <div class="modal fade" id="vehicleFormModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ selectedVehicle.id ? 'Editar Vehículo' : 'Nuevo Vehículo' }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="vehicleMarca" class="form-label">Marca</label>
                    <input type="text" class="form-control" id="vehicleMarca" v-model="selectedVehicle.marca">
                  </div>
                  <div class="col-md-6">
                    <label for="vehicleModelo" class="form-label">Modelo</label>
                    <input type="text" class="form-control" id="vehicleModelo" v-model="selectedVehicle.modelo">
                  </div>
                  <div class="col-md-4">
                    <label for="vehicleAnio" class="form-label">Año</label>
                    <input type="number" class="form-control" id="vehicleAnio" v-model="selectedVehicle.anio">
                  </div>
                  <div class="col-md-4">
                    <label for="vehicleColor" class="form-label">Color</label>
                    <input type="text" class="form-control" id="vehicleColor" v-model="selectedVehicle.color">
                  </div>
                  <div class="col-md-4">
                    <label for="vehicleMatricula" class="form-label">Matrícula</label>
                    <input type="text" class="form-control" id="vehicleMatricula" v-model="selectedVehicle.matricula">
                  </div>
                  <div class="col-md-6">
                    <label for="vehicleEstado" class="form-label">Estado</label>
                    <select class="form-select" id="vehicleEstado" v-model="selectedVehicle.estado">
                      <option value="Disponible">Disponible</option>
                      <option value="Asignado">Asignado</option>
                    </select>
                  </div>
                  <div class="col-md-6" v-if="selectedVehicle.estado === 'Asignado'">
                    <label for="vehicleUsuario" class="form-label">Usuario Asignado</label>
                    <select class="form-select" id="vehicleUsuario" v-model="selectedVehicle.usuarioId">
                      <option value="" disabled selected>Seleccione un usuario</option>
                      <option v-for="usuario in usuarios" :key="usuario.id" :value="usuario.id">
                        {{ usuario.nombre }} {{ usuario.apellido }}
                      </option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="vehicleImagen" class="form-label">Imagen Principal</label>
                    <input type="file" class="form-control" id="vehicleImagen" @change="uploadVehicleImage($event, true)" accept="image/*">
                    <div class="mt-2" v-if="selectedVehicle.imagen">
                      <img :src="selectedVehicle.imagen" class="img-thumbnail" style="height: 100px;">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="vehicleImagenes" class="form-label">Imágenes Adicionales</label>
                    <input type="file" class="form-control" id="vehicleImagenes" @change="uploadVehicleImage($event, false)" accept="image/*" multiple>
                    <div class="d-flex mt-2 flex-wrap">
                      <div v-for="(img, index) in selectedVehicle.imagenes" :key="index" class="m-1">
                        <img :src="img" class="img-thumbnail" style="height: 80px; width: 80px; object-fit: cover;">
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" @click="saveVehicle" :disabled="isLoading">
                <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                Guardar
              </button>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script id="app-script">
    const { createApp, ref, computed, onMounted, watch } = Vue;
    
    const app = createApp({
      setup() {
        // Estado de autenticación
        const isAuthenticated = ref(false);
        const currentUser = ref({});
        const loginForm = ref({ email: '', password: '' });
        const loginError = ref('');
        const isLoading = ref(false);
        const isUpdating = ref(false);
        
        // Rutas y navegación
        const currentRoute = ref('catalogo');
        
        // Formularios
        const profileForm = ref({
          nombre: '',
          apellido: '',
          email: '',
          telefono: '',
          currentPassword: '',
          newPassword: ''
        });
        
        const userForm = ref({
          id: null,
          nombre: '',
          apellido: '',
          email: '',
          telefono: '',
          rol: 'Usuario',
          password: ''
        });
        
        const newAssignment = ref({
          vehiculoId: '',
          usuarioId: '',
          fecha: new Date().toISOString().split('T')[0]
        });
        
        // Datos de la aplicación
        const vehiculos = ref([]);
        const asignaciones = ref([]);
        const usuarios = ref([]);
        const dashboardData = ref([]);
        const selectedVehicle = ref(null);
        const isEditingUser = ref(false);
        
        // Modales
        let vehicleDetailModal = null;
        let newAssignmentModal = null;
        let userModal = null;
        let vehicleFormModal = null;
        
        // Mapa
        let map = null;
        
        // WebSocket connection
        let socket = null;
        
        // Computados
        const isAdmin = computed(() => {
          return ['Administrador', 'Administrador Global'].includes(currentUser.value.rol);
        });
        
        const isGlobalAdmin = computed(() => {
          return currentUser.value.rol === 'Administrador Global';
        });
        
        const vehiculosDisponibles = computed(() => {
          return vehiculos.value.filter(v => v.estado === 'Disponible');
        });
        
        // Validación de contraseña
        const passwordHasUppercase = computed(() => /[A-Z]/.test(profileForm.value.newPassword));
        const passwordHasLowercase = computed(() => /[a-z]/.test(profileForm.value.newPassword));
        const passwordHasNumber = computed(() => /[0-9]/.test(profileForm.value.newPassword));
        const passwordHasSpecial = computed(() => /[^A-Za-z0-9]/.test(profileForm.value.newPassword));
        const passwordHasMinLength = computed(() => profileForm.value.newPassword.length >= 8);
        
        const isValidPassword = computed(() => {
          return passwordHasUppercase.value && 
                 passwordHasLowercase.value && 
                 passwordHasNumber.value && 
                 passwordHasSpecial.value && 
                 passwordHasMinLength.value;
        });
        
        // Validación de contraseña para usuarios
        const userPasswordHasUppercase = computed(() => /[A-Z]/.test(userForm.value.password));
        const userPasswordHasLowercase = computed(() => /[a-z]/.test(userForm.value.password));
        const userPasswordHasNumber = computed(() => /[0-9]/.test(userForm.value.password));
        const userPasswordHasSpecial = computed(() => /[^A-Za-z0-9]/.test(userForm.value.password));
        const userPasswordHasMinLength = computed(() => userForm.value.password.length >= 8);
        
        const isValidUserPassword = computed(() => {
          return userPasswordHasUppercase.value && 
                 userPasswordHasLowercase.value && 
                 userPasswordHasNumber.value && 
                 userPasswordHasSpecial.value && 
                 userPasswordHasMinLength.value;
        });
        
        // Métodos
        const login = async () => {
          isLoading.value = true;
          try {
            // Simular petición a API
            // await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Updated login credentials and roles
            if (loginForm.value.email === 'globaladmin@ejemplo.com' && loginForm.value.password === 'Admin123!') {
              currentUser.value = {
                id: 1,
                nombre: 'Admin',
                apellido: 'Global',
                email: 'globaladmin@ejemplo.com',
                telefono: '555-1234',
                rol: 'Administrador Global',
                foto: 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png'
              };
              isAuthenticated.value = true;
              loadData();
              initWebSocket(); // Initialize WebSocket after authentication
            } else if (loginForm.value.email === 'admin@ejemplo.com' && loginForm.value.password === 'Admin123!') {
              currentUser.value = {
                id: 2,
                nombre: 'Admin',
                apellido: 'Normal',
                email: 'admin@ejemplo.com',
                telefono: '555-5678',
                rol: 'Administrador',
                foto: 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png'
              };
              isAuthenticated.value = true;
              loadData();
            } else if (loginForm.value.email === 'usuario@ejemplo.com' && loginForm.value.password === 'User123!') {
              currentUser.value = {
                id: 3,
                nombre: 'Usuario',
                apellido: 'Normal',
                email: 'usuario@ejemplo.com',
                telefono: '555-5678',
                rol: 'Usuario',
                foto: 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png'
              };
              isAuthenticated.value = true;
              loadData();
            } else {
              loginError.value = 'Credenciales incorrectas';
            }
          } catch (error) {
            loginError.value = 'Error al iniciar sesión';
          } finally {
            isLoading.value = false;
          }
        };
        
        const logout = () => {
          isAuthenticated.value = false;
          currentUser.value = {};

          // Close WebSocket connection
          if (socket) {
            socket.close();
            socket = null;
          }
        };
        
        const setCurrentRoute = (route) => {
          // Check if user has permission to access the route
          if (!isAdmin.value && ['asignaciones', 'mapa', 'usuarios', 'dashboard'].includes(route)) {
            alert('No tienes permisos para acceder a esta sección');
            return;
          }
          currentRoute.value = route;
          if (route === 'mapa' && !map) {
            // Inicializar mapa cuando navegamos a esa ruta
            setTimeout(() => {
              initMap();
            }, 100);
          }
        };
        
        const loadData = async () => {
          // Cargar datos de ejemplo
          vehiculos.value = generateVehicles();
          asignaciones.value = generateAssignments();
          usuarios.value = generateUsers();
          dashboardData.value = generateDashboardData();
          
          // Inicializar formulario de perfil
          profileForm.value = {
            nombre: currentUser.value.nombre,
            apellido: currentUser.value.apellido,
            email: currentUser.value.email,
            telefono: currentUser.value.telefono,
            currentPassword: '',
            newPassword: ''
          };
        };
        
        const initMap = () => {
          if (map) return;
          
          // Coordenadas de Guadalajara, Jalisco
          const guadalajara = [20.6597, -103.3496];
          
          map = L.map('map').setView(guadalajara, 12);
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);
          
          // Add markers based on user role
          addVehicleMarkers();
          
          // Set up real-time updates
          setInterval(() => {
            updateVehicleLocations();
          }, 30000); // Update every 30 seconds
        };
        
        const addVehicleMarkers = () => {
          if (!map) return;
          
          // Clear existing markers
          if (vehicleMarkers.value) {
            vehicleMarkers.value.forEach(marker => map.removeLayer(marker));
          }
          vehicleMarkers.value = [];
          
          // Add markers based on user role
          const vehiclesToShow = isGlobalAdmin.value ? 
            vehiculos.value : 
            vehiculos.value.filter(v => v.estado === 'Asignado' && v.usuario === `${currentUser.value.nombre} ${currentUser.value.apellido}`);
          
          vehiclesToShow.forEach(vehiculo => {
            // Use stored coordinates or generate random ones if not available
            const lat = vehiculo.lat || (20.6597 + (Math.random() - 0.5) * 0.1);
            const lng = vehiculo.lng || (-103.3496 + (Math.random() - 0.5) * 0.1);
            
            // Store coordinates if not already stored
            if (!vehiculo.lat) {
              vehiculo.lat = lat;
              vehiculo.lng = lng;
            }
            
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`
              <strong>${vehiculo.marca} ${vehiculo.modelo}</strong><br>
              Matrícula: ${vehiculo.matricula}<br>
              Estado: ${vehiculo.estado}
              ${vehiculo.usuario ? `<br>Asignado a: ${vehiculo.usuario}` : ''}
              <br><br>
              <button class="btn btn-sm btn-primary update-location" data-vehicle-id="${vehiculo.id}">
                Actualizar ubicación
              </button>
            `);
            
            marker.on('popupopen', () => {
              setTimeout(() => {
                const updateBtn = document.querySelector(`.update-location[data-vehicle-id="${vehiculo.id}"]`);
                if (updateBtn) {
                  updateBtn.addEventListener('click', () => updateVehicleLocation(vehiculo));
                }
              }, 100);
            });
            
            vehicleMarkers.value.push(marker);
          });
        };
        
        const updateVehicleLocations = async () => {
          try {
            // Simulate API call to update locations
            console.log('Updating vehicle locations...');
            
            // In a real application, this would be an API call to a GPS service
            vehiculos.value.forEach(vehiculo => {
              // Small random movement to simulate GPS updates
              if (vehiculo.lat && vehiculo.lng) {
                vehiculo.lat += (Math.random() - 0.5) * 0.005;
                vehiculo.lng += (Math.random() - 0.5) * 0.005;
              }
            });
            
            // Refresh markers
            addVehicleMarkers();
          } catch (error) {
            console.error('Error updating vehicle locations:', error);
          }
        };
        
        const updateVehicleLocation = async (vehiculo) => {
          try {
            isLoading.value = true;
            
            // Show a form to input new coordinates
            const latInput = prompt("Ingrese la nueva latitud:", vehiculo.lat || "20.6597");
            const lngInput = prompt("Ingrese la nueva longitud:", vehiculo.lng || "-103.3496");
            
            // Validate inputs
            const lat = parseFloat(latInput);
            const lng = parseFloat(lngInput);
            
            if (isNaN(lat) || isNaN(lng)) {
              alert("Por favor ingrese coordenadas válidas.");
              return;
            }
            
            // Update vehicle coordinates
            vehiculo.lat = lat;
            vehiculo.lng = lng;
            
            // Send update through WebSocket
            sendWebSocketUpdate('LOCATION_UPDATE', { 
              vehiculoId: vehiculo.id,
              lat: lat,
              lng: lng
            });
            
            // Update markers
            addVehicleMarkers();
            
            alert(`Ubicación de vehículo ${vehiculo.matricula} actualizada correctamente`);
          } catch (error) {
            console.error('Error updating vehicle location:', error);
            alert('Error al actualizar la ubicación');
          } finally {
            isLoading.value = false;
          }
        };
        
        const openVehicleModal = (vehiculo) => {
          selectedVehicle.value = vehiculo;
          if (vehicleDetailModal) {
            vehicleDetailModal.show();
          } else {
            console.error('vehicleDetailModal no está inicializado');
          }
        };
        
        const openNewAssignmentModal = () => {
          newAssignment.value = {
            vehiculoId: '',
            usuarioId: '',
            fecha: new Date().toISOString().split('T')[0]
          };
          if (newAssignmentModal) {
            newAssignmentModal.show();
          } else {
            console.error('newAssignmentModal is not initialized');
          }
        };
        
        const createAssignment = async () => {
          isLoading.value = true;
          try {
            // Simular petición a API
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const vehiculo = vehiculos.value.find(v => v.id === newAssignment.value.vehiculoId);
            const usuario = usuarios.value.find(u => u.id === newAssignment.value.usuarioId);

            if (vehiculo && usuario) {
              const newAssignmentData = {
                id: asignaciones.value.length + 1,
                vehiculoId: vehiculo.id,
                usuarioId: usuario.id,
                usuario: `${usuario.nombre} ${usuario.apellido}`,
                vehiculo: `${vehiculo.marca} ${vehiculo.modelo}`,
                matricula: vehiculo.matricula,
                fecha: newAssignment.value.fecha
              };

              // Send update through WebSocket
              sendWebSocketUpdate('ASSIGNMENT_UPDATE', { 
                action: 'CREATE', 
                assignment: newAssignmentData 
              });

              // No need to update local state as it will be updated by the WebSocket handler

              newAssignmentModal.hide();
            }
          } catch (error) {
            console.error('Error al crear asignación:', error);
          } finally {
            isLoading.value = false;
          }
        };
        
        const deleteAssignment = async (id) => {
          if (!confirm('¿Está seguro de eliminar esta asignación?')) return;
          
          isLoading.value = true;
          try {
            // Simular petición a API
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const asignacion = asignaciones.value.find(a => a.id === id);
            if (asignacion) {
              // Send update through WebSocket
              sendWebSocketUpdate('ASSIGNMENT_UPDATE', { 
                action: 'DELETE', 
                assignmentId: id,
                matricula: asignacion.matricula 
              });

              // No need to update local state as it will be updated by the WebSocket handler
            }
          } catch (error) {
            console.error('Error al eliminar asignación:', error);
          } finally {
            isLoading.value = false;
          }
        };
        
        const openNewUserModal = () => {
          isEditingUser.value = false;
          userForm.value = {
            id: null,
            nombre: '',
            apellido: '',
            email: '',
            telefono: '',
            rol: 'Usuario',
            password: ''
          };
          if (userModal) {
            userModal.show();
          } else {
            console.error('userModal is not initialized');
          }
        };
        
        const editUser = (usuario) => {
          isEditingUser.value = true;
          userForm.value = {
            id: usuario.id,
            nombre: usuario.nombre,
            apellido: usuario.apellido,
            email: usuario.email,
            telefono: usuario.telefono,
            rol: usuario.rol,
            password: ''
          };
          userModal.show();
        };
        
        const saveUser = async () => {
          isLoading.value = true;
          try {
            // Validar contraseña si es un nuevo usuario
            if (!isEditingUser.value && !isValidUserPassword.value) {
              alert('La contraseña no cumple con los requisitos de seguridad');
              return;
            }

            // Simular petición a API
            await new Promise(resolve => setTimeout(resolve, 1000));

            if (isEditingUser.value) {
              // Prepare user data based on role permissions
              let userData = userForm.value;

              // If not Global Admin, restrict fields that can be updated
              if (currentUser.value.rol !== 'Administrador Global') {
                userData = {
                  id: userForm.value.id,
                  nombre: userForm.value.nombre,
                  apellido: userForm.value.apellido,
                  telefono: userForm.value.telefono
                  // Email and role can't be changed by regular admins
                };
              }

              // Send update through WebSocket
              sendWebSocketUpdate('USER_UPDATE', { 
                action: 'UPDATE', 
                user: userData 
              });
            } else {
              // Create new user
              const newUser = {
                id: usuarios.value.length + 1,
                nombre: userForm.value.nombre,
                apellido: userForm.value.apellido,
                email: userForm.value.email,
                telefono: userForm.value.telefono,
                rol: userForm.value.rol
              };

              // Send update through WebSocket
              sendWebSocketUpdate('USER_UPDATE', { 
                action: 'CREATE', 
                user: newUser 
              });
            }

            userModal.hide();
          } catch (error) {
            console.error('Error al guardar usuario:', error);
          } finally {
            isLoading.value = false;
          }
        };
        
        const deleteUser = async (id) => {
          if (!confirm('¿Está seguro de eliminar este usuario?')) return;
          
          isLoading.value = true;
          try {
            // Simular petición a API
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Send update through WebSocket
            sendWebSocketUpdate('USER_UPDATE', { 
              action: 'DELETE', 
              userId: id 
            });

            // No need to update local state as it will be updated by the WebSocket handler
          } catch (error) {
            console.error('Error al eliminar usuario:', error);
          } finally {
            isLoading.value = false;
          }
        };
        
        const updateProfile = async () => {
          isUpdating.value = true;
          try {
            // Validar contraseña si se está cambiando
            if (profileForm.value.newPassword && !isValidPassword.value) {
              alert('La nueva contraseña no cumple con los requisitos de seguridad');
              return;
            }

            // Simular petición a API
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Prepare user data for update
            const userData = {
              id: currentUser.value.id,
              nombre: profileForm.value.nombre,
              apellido: profileForm.value.apellido,
              telefono: profileForm.value.telefono
              // Email can't be changed by users
            };

            // Send update through WebSocket
            sendWebSocketUpdate('USER_UPDATE', { 
              action: 'UPDATE', 
              user: userData 
            });

            // Limpiar campos de contraseña
            profileForm.value.currentPassword = '';
            profileForm.value.newPassword = '';

            alert('Perfil actualizado con éxito');
          } catch (error) {
            console.error('Error al actualizar perfil:', error);
            alert('Error al actualizar perfil');
          } finally {
            isUpdating.value = false;
          }
        };
        
        const updateProfilePhoto = () => {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          
          fileInput.onchange = async (e) => {
            if (e.target.files.length > 0) {
              isUpdating.value = true;
              try {
                const file = e.target.files[0];
                
                // Simulate uploading to server
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Create a URL for the selected image
                const reader = new FileReader();
                reader.onload = (event) => {
                  // Update profile photo
                  currentUser.value.foto = event.target.result;
                  alert('Foto de perfil actualizada correctamente');
                  isUpdating.value = false;
                };
                reader.readAsDataURL(file);
              } catch (error) {
                console.error('Error updating profile photo:', error);
                alert('Error al actualizar la foto de perfil');
                isUpdating.value = false;
              }
            }
          };
          
          fileInput.click();
        };
        
        const getRoleBadgeClass = (rol) => {
          switch (rol) {
            case 'Administrador Global':
              return 'bg-danger';
            case 'Administrador':
              return 'bg-warning';
            default:
              return 'bg-info';
          }
        };
        
        // WebSocket connection
        const initWebSocket = () => {
          // In a real application, this would connect to your actual WebSocket server
          socket = new WebSocket('ws://localhost:8080');

          socket.onopen = () => {
            console.log('WebSocket connection established');
          };

          socket.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);

              // Handle different types of updates
              switch (data.type) {
                case 'VEHICLE_UPDATE':
                  handleVehicleUpdate(data.payload);
                  break;
                case 'ASSIGNMENT_UPDATE':
                  handleAssignmentUpdate(data.payload);
                  break;
                case 'USER_UPDATE':
                  handleUserUpdate(data.payload);
                  break;
                case 'LOCATION_UPDATE':
                  handleLocationUpdate(data.payload);
                  break;
                default:
                  console.log('Unknown update type:', data.type);
              }
            } catch (error) {
              console.error('Error processing WebSocket message:', error);
            }
          };

          socket.onclose = () => {
            console.log('WebSocket connection closed. Attempting to reconnect...');
            // Try to reconnect after 5 seconds
            setTimeout(() => {
              initWebSocket();
            }, 5000);
          };

          socket.onerror = (error) => {
            console.error('WebSocket error:', error);
          };
        };

        // WebSocket message handlers
        const handleVehicleUpdate = (data) => {
          if (data.action === 'CREATE') {
            vehiculos.value.push(data.vehicle);
          } else if (data.action === 'UPDATE') {
            const index = vehiculos.value.findIndex(v => v.id === data.vehicle.id);
            if (index !== -1) {
              vehiculos.value[index] = data.vehicle;
            }
          } else if (data.action === 'DELETE') {
            vehiculos.value = vehiculos.value.filter(v => v.id !== data.vehicleId);
          }
          
          // Update dashboard data
          if (isGlobalAdmin.value) {
            dashboardData.value = generateDashboardData();
          }
          
          // If map is initialized, update markers
          if (map) {
            addVehicleMarkers();
          }
        };

        const handleAssignmentUpdate = (data) => {
          if (data.action === 'CREATE') {
            asignaciones.value.push(data.assignment);

            // Update vehicle status
            const vehiculo = vehiculos.value.find(v => v.id === data.assignment.vehiculoId);
            if (vehiculo) {
              vehiculo.estado = 'Asignado';
              vehiculo.usuario = data.assignment.usuario;
            }
          } else if (data.action === 'DELETE') {
            asignaciones.value = asignaciones.value.filter(a => a.id !== data.assignmentId);

            // Update vehicle status
            const vehiculo = vehiculos.value.find(v => v.matricula === data.matricula);
            if (vehiculo) {
              vehiculo.estado = 'Disponible';
              vehiculo.usuario = null;
            }
          }
        };

        const handleUserUpdate = (data) => {
          if (data.action === 'CREATE') {
            usuarios.value.push(data.user);
          } else if (data.action === 'UPDATE') {
            const index = usuarios.value.findIndex(u => u.id === data.user.id);
            if (index !== -1) {
              usuarios.value[index] = data.user;

              // Update current user if it's the same
              if (currentUser.value.id === data.user.id) {
                currentUser.value = { ...currentUser.value, ...data.user };
              }
            }
          } else if (data.action === 'DELETE') {
            usuarios.value = usuarios.value.filter(u => u.id !== data.userId);
          }
        };

        const handleLocationUpdate = (data) => {
          const vehiculo = vehiculos.value.find(v => v.id === data.vehiculoId);
          if (vehiculo) {
            vehiculo.lat = data.lat;
            vehiculo.lng = data.lng;

            // Update map if it's initialized
            if (map) {
              addVehicleMarkers();
            }
          }
        };

        // Send updates through WebSocket
        const sendWebSocketUpdate = (type, payload) => {
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type, payload }));
          } else {
            console.error('WebSocket is not connected');
          }
        };

        // Datos de ejemplo
        const generateVehicles = () => {
          const marcas = ['Toyota', 'Honda', 'Nissan', 'Ford', 'Chevrolet'];
          const modelos = {
            'Toyota': ['Corolla', 'Camry', 'RAV4', 'Hilux', 'Yaris'],
            'Honda': ['Civic', 'Accord', 'CR-V', 'HR-V', 'Pilot'],
            'Nissan': ['Sentra', 'Altima', 'Versa', 'X-Trail', 'Kicks'],
            'Ford': ['Focus', 'Escape', 'Explorer', 'Ranger', 'F-150'],
            'Chevrolet': ['Spark', 'Aveo', 'Cruze', 'Equinox', 'Silverado']
          };
          const colores = ['Blanco', 'Negro', 'Rojo', 'Azul', 'Plata', 'Gris'];
          const vehiculos = [];
          
          for (let i = 1; i <= 25; i++) {
            const marca = marcas[Math.floor(Math.random() * marcas.length)];
            const modelo = modelos[marca][Math.floor(Math.random() * modelos[marca].length)];
            const anio = 2018 + Math.floor(Math.random() * 5);
            const color = colores[Math.floor(Math.random() * colores.length)];
            const estado = Math.random() > 0.6 ? 'Disponible' : 'Asignado';
            let usuario = null;
            
            if (estado === 'Asignado') {
              if (Math.random() > 0.5) {
                usuario = 'Admin Sistema';
              } else {
                usuario = 'Usuario Normal';
              }
            }
            
            vehiculos.push({
              id: i,
              marca,
              modelo,
              anio,
              color,
              matricula: `ABC-${1000 + i}`,
              estado,
              usuario,
              imagen: `https://cdn.pixabay.com/photo/2016/02/13/13/11/oldtimer-1197800_960_720.jpg`,
              imagenes: [
                'https://cdn.pixabay.com/photo/2015/05/28/23/12/auto-788747_960_720.jpg',
                'https://cdn.pixabay.com/photo/2013/07/12/12/56/car-146185_960_720.png',
                'https://cdn.pixabay.com/photo/2014/09/07/22/34/car-race-438467_960_720.jpg'
              ],
              actualizacion: '2023-05-15'
            });
          }
          
          return vehiculos;
        };
        
        const generateAssignments = () => {
          const asignaciones = [];
          const vehiculosAsignados = vehiculos.value.filter(v => v.estado === 'Asignado');
          
          vehiculosAsignados.forEach((vehiculo, index) => {
            asignaciones.push({
              id: index + 1,
              usuario: vehiculo.usuario,
              vehiculo: `${vehiculo.marca} ${vehiculo.modelo}`,
              matricula: vehiculo.matricula,
              fecha: '2023-01-15'
            });
          });
          
          return asignaciones;
        };
        
        const generateUsers = () => {
          return [
            {
              id: 1,
              nombre: 'Admin',
              apellido: 'Global',
              email: 'globaladmin@ejemplo.com',
              telefono: '555-1234',
              rol: 'Administrador Global'
            },
            {
              id: 2,
              nombre: 'Admin',
              apellido: 'Normal',
              email: 'admin@ejemplo.com',
              telefono: '555-5678',
              rol: 'Administrador'
            },
            {
              id: 3,
              nombre: 'Usuario',
              apellido: 'Normal',
              email: 'usuario@ejemplo.com',
              telefono: '555-5678',
              rol: 'Usuario'
            },
            {
              id: 4,
              nombre: 'María',
              apellido: 'González',
              email: 'maria@ejemplo.com',
              telefono: '555-3456',
              rol: 'Administrador'
            }
          ];
        };
        
        const generateDashboardData = () => {
          const marcas = {};
          
          // Agrupar vehículos por marca y estado
          vehiculos.value.forEach(vehiculo => {
            if (!marcas[vehiculo.marca]) {
              marcas[vehiculo.marca] = {
                nombre: vehiculo.marca,
                disponibles: 0,
                asignados: 0
              };
            }
            
            if (vehiculo.estado === 'Disponible') {
              marcas[vehiculo.marca].disponibles++;
            } else {
              marcas[vehiculo.marca].asignados++;
            }
          });
          
          return Object.values(marcas);
        };
        
        // Hooks del ciclo de vida
        onMounted(() => {
          // Inicializar modales de Bootstrap
          const vehicleDetailEl = document.getElementById('vehicleDetailModal');
          if (vehicleDetailEl) {
            vehicleDetailModal = new bootstrap.Modal(vehicleDetailEl, { backdrop: true });
          }
          
          const newAssignmentEl = document.getElementById('newAssignmentModal');
          if (newAssignmentEl) {
            newAssignmentModal = new bootstrap.Modal(newAssignmentEl, { backdrop: true });
          }
          
          const userModalEl = document.getElementById('userModal');
          if (userModalEl) {
            userModal = new bootstrap.Modal(userModalEl, { backdrop: true });
          }
          
          const vehicleFormEl = document.getElementById('vehicleFormModal');
          if (vehicleFormEl) {
            vehicleFormModal = new bootstrap.Modal(vehicleFormEl, { backdrop: true });
          }
        });
        
        // Add new computed property for filtered vehicles
        const filteredVehiculos = computed(() => {
          if (isAdmin.value) {
            return vehiculos.value;
          } else {
            // For regular users, only show vehicles assigned to them
            return vehiculos.value.filter(v => 
              v.usuario === `${currentUser.value.nombre} ${currentUser.value.apellido}` || 
              v.usuario === currentUser.value.nombre
            );
          }
        });
        
        // Define vehicleMarkers array at the beginning of the setup function
        const vehicleMarkers = ref([]);
        
        // Add a new method for vehicle management
        const openNewVehicleModal = () => {
          selectedVehicle.value = {
            id: null,
            marca: '',
            modelo: '',
            anio: new Date().getFullYear(),
            color: '',
            matricula: '',
            estado: 'Disponible',
            usuario: null,
            imagen: '',
            imagenes: [],
            actualizacion: new Date().toISOString().split('T')[0]
          };
          
          if (vehicleFormModal) {
            vehicleFormModal.show();
          } else {
            console.error('vehicleFormModal is not initialized');
          }
        };
        
        // Update or add this method for vehicle creation/edit
        const saveVehicle = async () => {
          isLoading.value = true;
          try {
            // Simular petición a API
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (selectedVehicle.value.id) {
              // Update existing vehicle
              // Send update through WebSocket
              sendWebSocketUpdate('VEHICLE_UPDATE', { 
                action: 'UPDATE', 
                vehicle: selectedVehicle.value 
              });
            } else {
              // Create new vehicle
              const newVehicle = {
                ...selectedVehicle.value,
                id: vehiculos.value.length + 1,
              };
              
              // Send update through WebSocket
              sendWebSocketUpdate('VEHICLE_UPDATE', { 
                action: 'CREATE', 
                vehicle: newVehicle 
              });
            }
            
            vehicleFormModal.hide();
          } catch (error) {
            console.error('Error al guardar vehículo:', error);
          } finally {
            isLoading.value = false;
          }
        };
        
        // Add a method to handle vehicle image upload
        const uploadVehicleImage = (event, isMainImage = true) => {
          const files = event.target.files;
          if (!files.length) return;
          
          const file = files[0];
          const reader = new FileReader();
          
          reader.onload = (e) => {
            if (isMainImage) {
              selectedVehicle.value.imagen = e.target.result;
            } else {
              if (!selectedVehicle.value.imagenes) {
                selectedVehicle.value.imagenes = [];
              }
              selectedVehicle.value.imagenes.push(e.target.result);
            }
          };
          
          reader.readAsDataURL(file);
        };
        
        // Add this method to your Vue app setup function
        const saveVehicleComments = () => {
          if (!selectedVehicle.value.nuevoComentario) return;
          
          // Initialize historial array if it doesn't exist
          if (!selectedVehicle.value.historial) {
            selectedVehicle.value.historial = [];
          }
          
          // Add the new comment to the historial
          selectedVehicle.value.historial.push({
            fecha: new Date().toLocaleDateString(),
            accion: 'Comentario añadido',
            comentario: selectedVehicle.value.nuevoComentario
          });
          
          // Clear the comment input
          selectedVehicle.value.nuevoComentario = '';
          
          // Show a success message
          alert('Comentario guardado con éxito');
          
          // Send update through WebSocket if connected
          if (socket && socket.readyState === WebSocket.OPEN) {
            sendWebSocketUpdate('VEHICLE_UPDATE', { 
              action: 'UPDATE', 
              vehicle: selectedVehicle.value 
            });
          }
        };
        
        return {
          // Estado
          isAuthenticated,
          currentUser,
          loginForm,
          loginError,
          isLoading,
          isUpdating,
          currentRoute,
          profileForm,
          userForm,
          newAssignment,
          vehiculos,
          asignaciones,
          usuarios,
          dashboardData,
          selectedVehicle,
          isEditingUser,
          
          // Computados
          isAdmin,
          isGlobalAdmin,
          vehiculosDisponibles,
          passwordHasUppercase,
          passwordHasLowercase,
          passwordHasNumber,
          passwordHasSpecial,
          passwordHasMinLength,
          isValidPassword,
          userPasswordHasUppercase,
          userPasswordHasLowercase,
          userPasswordHasNumber,
          userPasswordHasSpecial,
          userPasswordHasMinLength,
          isValidUserPassword,
          filteredVehiculos,
          
          // Métodos
          login,
          logout,
          setCurrentRoute,
          openVehicleModal,
          openNewAssignmentModal,
          createAssignment,
          deleteAssignment,
          openNewUserModal,
          editUser,
          saveUser,
          deleteUser,
          updateProfile,
          updateProfilePhoto,
          getRoleBadgeClass,
          openNewVehicleModal,
          saveVehicle,
          uploadVehicleImage,
          saveVehicleComments
        };
      }
    });
    
    app.mount('#app');
  </script>
</body>
</html>
