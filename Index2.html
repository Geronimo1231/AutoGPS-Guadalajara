<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestión de Vehículos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style id="app-style">
    [v-cloak] { display: none; }
    
    html, body {
      height: 100%;
      background-color: #e8ecef; /* Light background */
      color: #ffffff; /* White text */
    }
    
    #app {
      height: 100%;
    }
    
    .sidebar {
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      z-index: 100;
      padding-top: 60px;
      background-color: #9ec3ff; /* Light blue sidebar */
      transition: all 0.3s;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar-link {
      padding: 10px 15px;
      display: block;
      color: #ffffff; /* White text */
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .sidebar-link:hover, .sidebar-link.active {
      color: #ffffff; /* Keep white text on hover */
      background-color: rgba(255, 255, 255, 0.2); /* Lighter background on hover */
    }
    
    .sidebar-link i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 20px;
      padding-top: 70px;
      min-height: 100%;
      background-color: #e8ecef; /* Light background */
    }
    
    .navbar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1030;
      background-color: #a8d5ff !important; /* Light blue navbar */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .navbar-dark {
      background-color: #a8d5ff !important; /* Light blue navbar */
    }
    
    .navbar-dark .navbar-brand, 
    .navbar-dark .nav-link,
    .navbar-dark .navbar-toggler-icon {
      color: #ffffff !important; /* White text */
    }
    
    .navbar-brand {
      margin-left: 20px;
    }
    
    .vehicle-card {
      transition: transform 0.3s;
      height: 100%;
    }
    
    .vehicle-card:hover {
      transform: translateY(-5px);
      cursor: pointer;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    
    #map {
      height: calc(100vh - 140px);
      width: 100%;
      border-radius: 8px;
    }
    
    .profile-avatar {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #e8ecef;
    }
    
    .login-form {
      width: 100%;
      max-width: 400px;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .password-feedback {
      font-size: 0.8rem;
    }
    
    .password-requirement {
      margin-bottom: 5px;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 80px;
      }
      
      .sidebar-link span {
        display: none;
      }
      
      .sidebar-link i {
        margin-right: 0;
        font-size: 1.2rem;
      }
      
      .main-content {
        margin-left: 80px;
      }
    }
    
    .card {
      background-color: #b8d1f3; /* Light blue card */
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      color: #ffffff; /* White text */
    }
    
    .btn-primary {
      background-color: #7ab8ff; /* Light blue button */
      border-color: #7ab8ff;
      color: #ffffff; /* White text */
    }
    
    .btn-primary:hover {
      background-color: #5a9de0; /* Slightly darker on hover */
      border-color: #5a9de0;
      color: #ffffff; /* White text */
    }
    
    .btn-secondary {
      background-color: #b0c4de; /* Light steel blue */
      border-color: #b0c4de;
      color: #ffffff; /* White text */
    }
    
    .btn-secondary:hover {
      background-color: #92a9c9; /* Slightly darker on hover */
      border-color: #92a9c9;
      color: #ffffff; /* White text */
    }
    
    .bg-dark {
      background-color: #9ec3ff !important; /* Light blue instead of dark */
      color: #ffffff !important; /* White text */
    }
    
    .navbar-dark .navbar-nav .nav-link {
      color: #ffffff !important; /* White text */
    }
    
    .navbar-dark .navbar-nav .nav-link:hover {
      color: #e6e6e6 !important; /* Slightly darker white on hover */
    }
    
    .dropdown-menu {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border: none;
      background-color: #b8d1f3; /* Light blue dropdown */
    }
    
    .dropdown-item {
      color: #ffffff; /* White text */
    }
    
    .dropdown-item:hover {
      background-color: rgba(255, 255, 255, 0.2);
      color: #ffffff; /* White text */
    }
    
    .modal-content {
      background-color: #b8d1f3;
      color: #ffffff;
    }
    
    .modal-header, .modal-footer {
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .table {
      color: #ffffff;
    }
    
    .form-label {
      color: #ffffff;
    }
    
    .card-title, .card-text {
      color: #ffffff;
    }
    
    .form-control {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      color: #ffffff;
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .form-select {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      color: #ffffff;
    }
    
    .login-container {
      background-color: #e8ecef;
    }
    
    .login-form {
      background-color: #b8d1f3;
      color: #ffffff;
    }
</style>
</head>
<body>
  <div id="app" v-cloak>
    <!-- Login Screen -->
    <div v-if="!isAuthenticated" class="login-container">
      <div class="login-form">
        <h2 class="text-center mb-4">Iniciar Sesión</h2>
        <div class="mb-3">
          <label for="email" class="form-label">Correo Electrónico</label>
          <input type="email" class="form-control" id="email" v-model="loginForm.email" placeholder="correo@ejemplo.com">
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Contraseña</label>
          <input type="password" class="form-control" id="password" v-model="loginForm.password">
        </div>
        <div v-if="loginError" class="alert alert-danger">{{ loginError }}</div>
        <button class="btn btn-primary w-100" @click="login" :disabled="isLoading">
          <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
          Iniciar Sesión
        </button>
        
        <!-- Nueva sección de cuentas de demostración -->
        <div class="mt-4">
          <div class="card border-info">
            <div class="card-header bg-info text-white">
              <i class="fas fa-info-circle me-2"></i>Cuentas de Demostración
            </div>
            <div class="card-body">
              <p class="card-text mb-2">Utilice cualquiera de estas cuentas para probar el sistema:</p>
              <div class="mb-2">
                <span class="badge bg-danger me-2">Administrador Global</span>
                <small><strong>Correo:</strong> globaladmin@ejemplo.com | <strong>Contraseña:</strong> Admin123!</small>
              </div>
              <div class="mb-2">
                <span class="badge bg-warning text-dark me-2">Administrador</span>
                <small><strong>Correo:</strong> admin@ejemplo.com | <strong>Contraseña:</strong> Admin123!</small>
              </div>
              <div>
                <span class="badge bg-info me-2">Usuario</span>
                <small><strong>Correo:</strong> usuario@ejemplo.com | <strong>Contraseña:</strong> User123!</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Application after login -->
    <template v-if="isAuthenticated">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="javascript:void(0)">Sistema de Gestión de Vehículos</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="javascript:void(0)" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                  <i class="fas fa-user me-2"></i>{{ currentUser.nombre }}
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="javascript:void(0)" @click="setCurrentRoute('perfil')">Mi Perfil</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="javascript:void(0)" @click="logout">Cerrar Sesión</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Sidebar -->
      <div class="sidebar bg-dark">
        <a href="javascript:void(0)" @click="setCurrentRoute('catalogo')" class="sidebar-link" :class="{ active: currentRoute === 'catalogo' }">
          <i class="fas fa-car"></i> <span>Catálogo de Vehículos</span>
        </a>
        <a href="javascript:void(0)" @click="setCurrentRoute('asignaciones')" class="sidebar-link" :class="{ active: currentRoute === 'asignaciones' }" v-if="isAdmin">
          <i class="fas fa-exchange-alt"></i> <span>Asignaciones</span>
        </a>
        <a href="javascript:void(0)" @click="setCurrentRoute('mapa')" class="sidebar-link" :class="{ active: currentRoute === 'mapa' }" v-if="isAdmin">
          <i class="fas fa-map-marker-alt"></i> <span>Mapa</span>
        </a>
        <a v-if="isAdmin" href="javascript:void(0)" @click="setCurrentRoute('usuarios')" class="sidebar-link" :class="{ active: currentRoute === 'usuarios' }">
          <i class="fas fa-users"></i> <span>Usuarios</span>
        </a>
        <a v-if="isGlobalAdmin" href="javascript:void(0)" @click="setCurrentRoute('dashboard')" class="sidebar-link" :class="{ active: currentRoute === 'dashboard' }">
          <i class="fas fa-chart-bar"></i> <span>Dashboard</span>
        </a>
        <a href="javascript:void(0)" @click="setCurrentRoute('perfil')" class="sidebar-link" :class="{ active: currentRoute === 'perfil' }">
          <i class="fas fa-user-cog"></i> <span>Perfil</span>
        </a>
      </div>

      <!-- Position Fixed Toast -->
      <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div class="toast show" v-if="showConfirmation" :class="`bg-${confirmationType} text-white`">
          <div class="toast-header">
            <strong class="me-auto">Notificación</strong>
            <button type="button" class="btn-close" @click="showConfirmation = false"></button>
          </div>
          <div class="toast-body">
            {{ confirmationMessage }}
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Catálogo de Vehículos -->
        <div v-if="currentRoute === 'catalogo'">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Catálogo de Vehículos</h2>
            <button class="btn btn-primary" @click="openNewVehicleModal" v-if="isAdmin">
              <i class="fas fa-plus me-2"></i>Nuevo Vehículo
            </button>
          </div>
          <div class="row g-4">
            <div v-for="(vehiculo, index) in filteredVehiculos" :key="index" class="col-sm-6 col-md-4 col-lg-3">
              <div class="card vehicle-card shadow-sm" @click="openVehicleModal(vehiculo)">
                <img :src="vehiculo.imagen" class="card-img-top" alt="Vehículo" style="height: 180px; object-fit: cover;">
                <div class="card-body">
                  <h5 class="card-title">{{ vehiculo.matricula }}</h5>
                  <p class="card-text">{{ vehiculo.marca }} {{ vehiculo.modelo }} ({{ vehiculo.anio }})</p>
                  <p v-if="vehiculo.estado === 'Asignado'" class="card-text small text-muted">
                    <strong>Asignado a:</strong> {{ vehiculo.usuario }}
                  </p>
                  <div class="status-badge">
                    <span class="badge" :class="vehiculo.estado === 'Disponible' ? 'bg-success' : 'bg-warning'">
                      {{ vehiculo.estado }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Asignaciones -->
        <div v-if="currentRoute === 'asignaciones'">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Asignaciones</h2>
            <button class="btn btn-primary" @click="openNewAssignmentModal">
              <i class="fas fa-plus me-2"></i>Nueva Asignación
            </button>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Usuario</th>
                      <th>Vehículo</th>
                      <th>Matrícula</th>
                      <th>Fecha de Asignación</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(asignacion, index) in asignaciones" :key="index">
                      <td>{{ asignacion.usuario }}</td>
                      <td>{{ asignacion.vehiculo }}</td>
                      <td>{{ asignacion.matricula }}</td>
                      <td>{{ asignacion.fecha }}</td>
                      <td>
                        <button class="btn btn-sm btn-danger" @click="deleteAssignment(asignacion.id)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Mapa -->
        <div v-if="currentRoute === 'mapa'">
          <h2 class="mb-4">Mapa de Vehículos</h2>
          <div class="card">
            <div class="card-body">
              <div id="map"></div>
            </div>
          </div>
        </div>

        <!-- Usuarios (Admin only) -->
        <div v-if="currentRoute === 'usuarios' && isAdmin">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Gestión de Usuarios</h2>
            <button class="btn btn-primary" @click="openNewUserModal">
              <i class="fas fa-plus me-2"></i>Nuevo Usuario
            </button>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Apellido</th>
                      <th>Email</th>
                      <th>Teléfono</th>
                      <th>Rol</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(usuario, index) in usuarios" :key="index">
                      <td>{{ usuario.nombre }}</td>
                      <td>{{ usuario.apellido }}</td>
                      <td>{{ usuario.email }}</td>
                      <td>{{ usuario.telefono }}</td>
                      <td>
                        <span class="badge" :class="getRoleBadgeClass(usuario.rol)">
                          {{ usuario.rol }}
                        </span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-primary me-2" @click="editUser(usuario)">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" @click="deleteUser(usuario.id)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard (Global Admin only) -->
        <div v-if="currentRoute === 'dashboard' && isGlobalAdmin">
          <h2 class="mb-4">Dashboard de Marcas</h2>
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  Distribución de Vehículos por Marca
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Marca</th>
                          <th>Vehículos Disponibles</th>
                          <th>Vehículos Asignados</th>
                          <th>Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr v-for="(marca, index) in dashboardData" :key="index">
                          <td>{{ marca.nombre }}</td>
                          <td>{{ marca.disponibles }}</td>
                          <td>{{ marca.asignados }}</td>
                          <td>{{ marca.disponibles + marca.asignados }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Perfil de Usuario -->
        <div v-if="currentRoute === 'perfil'">
          <h2 class="mb-4">Mi Perfil</h2>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 text-center mb-4">
                  <img :src="currentUser.foto || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png'" 
                       alt="Foto de perfil" class="profile-avatar mb-3">
                  <div>
                    <button class="btn btn-outline-primary mt-2" @click="updateProfilePhoto">Cambiar Foto</button>
                  </div>
                </div>
                <div class="col-md-8">
                  <form @submit.prevent="updateProfile">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" v-model="profileForm.nombre">
                      </div>
                      <div class="col-md-6">
                        <label for="apellido" class="form-label">Apellido</label>
                        <input type="text" class="form-control" id="apellido" v-model="profileForm.apellido">
                      </div>
                      <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" v-model="profileForm.email" readonly>
                      </div>
                      <div class="col-md-6">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="telefono" v-model="profileForm.telefono">
                      </div>
                    </div>
                    
                    <h5 class="mt-4">Cambiar Contraseña</h5>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="currentPassword" class="form-label">Contraseña Actual</label>
                        <input type="password" class="form-control" id="currentPassword" v-model="profileForm.currentPassword">
                      </div>
                      <div class="col-md-6">
                        <label for="newPassword" class="form-label">Nueva Contraseña</label>
                        <input type="password" class="form-control" id="newPassword" v-model="profileForm.newPassword">
                      </div>
                      <div class="col-md-12">
                        <div class="password-feedback mt-2">
                          <div class="password-requirement" :class="passwordHasUppercase ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasUppercase ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos una letra mayúscula
                          </div>
                          <div class="password-requirement" :class="passwordHasLowercase ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasLowercase ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos una letra minúscula
                          </div>
                          <div class="password-requirement" :class="passwordHasNumber ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasNumber ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos un número
                          </div>
                          <div class="password-requirement" :class="passwordHasSpecial ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasSpecial ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos un carácter especial
                          </div>
                          <div class="password-requirement" :class="passwordHasMinLength ? 'text-success' : 'text-danger'">
                            <i class="fas" :class="passwordHasMinLength ? 'fa-check' : 'fa-times'"></i>
                            Contiene al menos 8 caracteres
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="mt-4">
                      <button type="submit" class="btn btn-primary" :disabled="isUpdating">
                        <span v-if="isUpdating" class="spinner-border spinner-border-sm me-2"></span>
                        Guardar Cambios
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vehicle Detail Modal -->
      <div class="modal fade" id="vehicleDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Detalle del Vehículo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" v-if="selectedVehicle">
              <div class="row">
                <div class="col-md-6">
                  <img :src="selectedVehicle.imagen" class="img-fluid rounded mb-3" alt="Vehículo">
                  <div class="row">
                    <div class="col-4 mb-3" v-for="(img, i) in selectedVehicle.imagenes || []" :key="i">
                      <img :src="img" class="img-fluid rounded" alt="Imagen adicional">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="additionalImages" class="form-label">Subir imágenes adicionales</label>
                    <input class="form-control" type="file" id="additionalImages" multiple>
                  </div>
                </div>
                <div class="col-md-6">
                  <ul class="list-group">
                    <li class="list-group-item"><strong>Matrícula:</strong> {{ selectedVehicle.matricula }}</li>
                    <li class="list-group-item"><strong>Marca:</strong> {{ selectedVehicle.marca }}</li>
                    <li class="list-group-item"><strong>Modelo:</strong> {{ selectedVehicle.modelo }}</li>
                    <li class="list-group-item"><strong>Año:</strong> {{ selectedVehicle.anio }}</li>
                    <li class="list-group-item"><strong>Color:</strong> {{ selectedVehicle.color }}</li>
                    <li class="list-group-item"><strong>Estado:</strong> 
                      <span class="badge" :class="selectedVehicle.estado === 'Disponible' ? 'bg-success' : 'bg-warning'">
                        {{ selectedVehicle.estado }}
                      </span>
                    </li>
                    <li class="list-group-item" v-if="selectedVehicle.usuario">
                      <strong>Asignado a:</strong> {{ selectedVehicle.usuario }}
                    </li>
                    <li class="list-group-item"><strong>Última actualización:</strong> {{ selectedVehicle.actualizacion }}</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- New Assignment Modal -->
      <div class="modal fade" id="newAssignmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Nueva Asignación</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="mb-3">
                  <label for="vehiculoSelect" class="form-label">Vehículo*</label>
                  <select class="form-select" :class="{'is-invalid': !newAssignment.vehiculoId && assignmentFormSubmitted}" 
                          id="vehiculoSelect" v-model="newAssignment.vehiculoId">
                    <option value="" disabled selected>Seleccione un vehículo</option>
                    <option v-for="vehiculo in vehiculosDisponibles" :key="vehiculo.id" :value="vehiculo.id">
                      {{ vehiculo.marca }} {{ vehiculo.modelo }} - {{ vehiculo.matricula }}
                    </option>
                  </select>
                  <div class="invalid-feedback">
                    Obligatorio
                  </div>
                </div>
                <div class="mb-3">
                  <label for="usuarioSelect" class="form-label">Usuario*</label>
                  <select class="form-select" :class="{'is-invalid': !newAssignment.usuarioId && assignmentFormSubmitted}" 
                          id="usuarioSelect" v-model="newAssignment.usuarioId">
                    <option value="" disabled selected>Seleccione un usuario</option>
                    <option v-for="usuario in usuarios" :key="usuario.id" :value="usuario.id">
                      {{ usuario.nombre }} {{ usuario.apellido }}
                    </option>
                  </select>
                  <div class="invalid-feedback">
                    Obligatorio
                  </div>
                </div>
                <div class="mb-3">
                  <label for="fechaAsignacion" class="form-label">Fecha de Asignación*</label>
                  <input type="date" class="form-control" :class="{'is-invalid': !newAssignment.fecha && assignmentFormSubmitted}"
                         id="fechaAsignacion" v-model="newAssignment.fecha">
                  <div class="invalid-feedback">
                    Obligatorio
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" @click="createAssignment" :disabled="isLoading">
                <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                Guardar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- New/Edit User Modal -->
      <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ isEditingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="userNombre" class="form-label">Nombre*</label>
                    <input type="text" class="form-control" :class="{'is-invalid': !userForm.nombre && userFormSubmitted}" 
                           id="userNombre" v-model="userForm.nombre">
                    <div class="invalid-feedback">
                      Obligatorio
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="userApellido" class="form-label">Apellido*</label>
                    <input type="text" class="form-control" :class="{'is-invalid': !userForm.apellido && userFormSubmitted}"
                           id="userApellido" v-model="userForm.apellido">
                    <div class="invalid-feedback">
                      Obligatorio
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="userEmail" class="form-label">Correo Electrónico*</label>
                    <input type="email" class="form-control" :class="{'is-invalid': !userForm.email && userFormSubmitted}"
                           id="userEmail" v-model="userForm.email" 
                           :readonly="isEditingUser && currentUser.rol !== 'Administrador Global'">
                    <div class="invalid-feedback">
                      Obligatorio
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="userTelefono" class="form-label">Teléfono*</label>
                    <input type="tel" class="form-control" :class="{'is-invalid': !userForm.telefono && userFormSubmitted}"
                           id="userTelefono" v-model="userForm.telefono">
                    <div class="invalid-feedback">
                      Obligatorio
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="userRol" class="form-label">Rol*</label>
                    <select class="form-select" :class="{'is-invalid': !userForm.rol && userFormSubmitted}"
                            id="userRol" v-model="userForm.rol" 
                            :disabled="isEditingUser && currentUser.rol !== 'Administrador Global'">
                      <option value="Usuario">Usuario</option>
                      <option value="Administrador">Administrador</option>
                      <option value="Administrador Global">Administrador Global</option>
                    </select>
                    <div class="invalid-feedback">
                      Obligatorio
                    </div>
                  </div>
                  <div class="col-md-6" v-if="!isEditingUser">
                    <label for="userPassword" class="form-label">Contraseña*</label>
                    <input type="password" class="form-control" :class="{'is-invalid': (!userForm.password || !isValidUserPassword) && userFormSubmitted}"
                           id="userPassword" v-model="userForm.password">
                    <div class="invalid-feedback" v-if="!isValidUserPassword && userForm.password">
                      La contraseña no cumple con los requisitos de seguridad
                    </div>
                    <div class="invalid-feedback" v-if="!userForm.password">
                      Obligatorio
                    </div>
                  </div>
                </div>
                
                <div v-if="!isEditingUser" class="password-feedback mt-3">
                  <div class="password-requirement" :class="userPasswordHasUppercase ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasUppercase ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos una letra mayúscula
                  </div>
                  <div class="password-requirement" :class="userPasswordHasLowercase ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasLowercase ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos una letra minúscula
                  </div>
                  <div class="password-requirement" :class="userPasswordHasNumber ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasNumber ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos un número
                  </div>
                  <div class="password-requirement" :class="userPasswordHasSpecial ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasSpecial ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos un carácter especial
                  </div>
                  <div class="password-requirement" :class="userPasswordHasMinLength ? 'text-success' : 'text-danger'">
                    <i class="fas" :class="userPasswordHasMinLength ? 'fa-check' : 'fa-times'"></i>
                    Contiene al menos 8 caracteres
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" @click="saveUser" :disabled="isLoading">
                <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                Guardar
              </button>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- New Vehicle Modal -->
  <div class="modal fade" id="newVehicleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo Vehículo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="vehicleMatricula" class="form-label">Matrícula*</label>
                <input type="text" class="form-control" id="vehicleMatricula" v-model="vehicleForm.matricula" required>
                <div class="invalid-feedback" v-if="!vehicleForm.matricula && vehicleFormSubmitted">
                  Obligatorio
                </div>
              </div>
              <div class="col-md-6">
                <label for="vehicleMarca" class="form-label">Marca*</label>
                <input type="text" class="form-control" id="vehicleMarca" v-model="vehicleForm.marca" required>
                <div class="invalid-feedback" v-if="!vehicleForm.marca && vehicleFormSubmitted">
                  Obligatorio
                </div>
              </div>
              <div class="col-md-6">
                <label for="vehicleModelo" class="form-label">Modelo*</label>
                <input type="text" class="form-control" id="vehicleModelo" v-model="vehicleForm.modelo" required>
                <div class="invalid-feedback" v-if="!vehicleForm.modelo && vehicleFormSubmitted">
                  Obligatorio
                </div>
              </div>
              <div class="col-md-6">
                <label for="vehicleAnio" class="form-label">Año*</label>
                <input type="number" class="form-control" id="vehicleAnio" v-model="vehicleForm.anio" 
                       min="1900" max="2025" required>
                <div class="invalid-feedback" v-if="vehicleForm.anio > 2025 && vehicleFormSubmitted">
                  El año no puede ser mayor a 2025
                </div>
                <div class="invalid-feedback" v-if="!vehicleForm.anio && vehicleFormSubmitted">
                  Obligatorio
                </div>
              </div>
              <div class="col-md-6">
                <label for="vehicleColor" class="form-label">Color*</label>
                <input type="text" class="form-control" id="vehicleColor" v-model="vehicleForm.color" required>
                <div class="invalid-feedback" v-if="!vehicleForm.color && vehicleFormSubmitted">
                  Obligatorio
                </div>
              </div>
              <div class="col-md-6">
                <label for="vehicleTipo" class="form-label">Tipo*</label>
                <select class="form-select" id="vehicleTipo" v-model="vehicleForm.tipo" required>
                  <option value="" disabled selected>Seleccione un tipo</option>
                  <option value="Sedán">Sedán</option>
                  <option value="SUV">SUV</option>
                  <option value="Hatchback">Hatchback</option>
                  <option value="Pickup">Pickup</option>
                  <option value="Camioneta">Camioneta</option>
                </select>
                <div class="invalid-feedback" v-if="!vehicleForm.tipo && vehicleFormSubmitted">
                  Obligatorio
                </div>
              </div>
              <div class="col-md-12">
                <label for="vehicleImagen" class="form-label">Imagen</label>
                <input type="file" class="form-control" id="vehicleImagen" @change="handleVehicleImageUpload">
                <div class="mt-2" v-if="vehicleForm.imagen">
                  <img :src="vehicleForm.imagen" class="img-thumbnail" style="max-height: 100px;">
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" @click="saveVehicle" :disabled="isLoading">
            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script id="app-script">
    const { createApp, ref, computed, onMounted, watch } = Vue;
    
    try {
      const app = createApp({
        setup() {
          // Estado de autenticación
          const isAuthenticated = ref(false);
          const currentUser = ref({});
          const loginForm = ref({ email: '', password: '' });
          const loginError = ref('');
          const isLoading = ref(false);
          const isUpdating = ref(false);
          
          // Rutas y navegación
          const currentRoute = ref('catalogo');
          
          // Formularios
          const profileForm = ref({
            nombre: '',
            apellido: '',
            email: '',
            telefono: '',
            currentPassword: '',
            newPassword: ''
          });
          
          const userForm = ref({
            id: null,
            nombre: '',
            apellido: '',
            email: '',
            telefono: '',
            rol: 'Usuario',
            password: ''
          });
          
          const newAssignment = ref({
            vehiculoId: '',
            usuarioId: '',
            fecha: new Date().toISOString().split('T')[0]
          });
          
          // Datos de la aplicación
          const vehiculos = ref([]);
          const asignaciones = ref([]);
          const usuarios = ref([]);
          const dashboardData = ref([]);
          const selectedVehicle = ref(null);
          const isEditingUser = ref(false);
          
          // Modales
          let vehicleDetailModal = null;
          let newAssignmentModal = null;
          let userModal = null;
          let newVehicleModal = null;
          let vehicleMarkers = [];  // Add this line to define vehicleMarkers array
          
          // Mapa
          let map = null;
          
          // WebSocket connection
          let socket = null;
          
          // Computados
          const isAdmin = computed(() => {
            return ['Administrador', 'Administrador Global'].includes(currentUser.value.rol);
          });
          
          const isGlobalAdmin = computed(() => {
            return currentUser.value.rol === 'Administrador Global';
          });
          
          const vehiculosDisponibles = computed(() => {
            return vehiculos.value.filter(v => v.estado === 'Disponible');
          });
          
          // Validación de contraseña
          const passwordHasUppercase = computed(() => /[A-Z]/.test(profileForm.value.newPassword));
          const passwordHasLowercase = computed(() => /[a-z]/.test(profileForm.value.newPassword));
          const passwordHasNumber = computed(() => /[0-9]/.test(profileForm.value.newPassword));
          const passwordHasSpecial = computed(() => /[^A-Za-z0-9]/.test(profileForm.value.newPassword));
          const passwordHasMinLength = computed(() => profileForm.value.newPassword.length >= 8);
          
          const isValidPassword = computed(() => {
            return passwordHasUppercase.value && 
                   passwordHasLowercase.value && 
                   passwordHasNumber.value && 
                   passwordHasSpecial.value && 
                   passwordHasMinLength.value;
          });
          
          // Validación de contraseña para usuarios
          const userPasswordHasUppercase = computed(() => /[A-Z]/.test(userForm.value.password));
          const userPasswordHasLowercase = computed(() => /[a-z]/.test(userForm.value.password));
          const userPasswordHasNumber = computed(() => /[0-9]/.test(userForm.value.password));
          const userPasswordHasSpecial = computed(() => /[^A-Za-z0-9]/.test(userForm.value.password));
          const userPasswordHasMinLength = computed(() => userForm.value.password.length >= 8);
          
          const isValidUserPassword = computed(() => {
            return userPasswordHasUppercase.value && 
                   userPasswordHasLowercase.value && 
                   userPasswordHasNumber.value && 
                   userPasswordHasSpecial.value && 
                   userPasswordHasMinLength.value;
          });
          
          // Variables para manejo de formularios de vehículos y asignaciones
          const vehicleForm = ref({
            id: null,
            matricula: '',
            marca: '',
            modelo: '',
            anio: new Date().getFullYear(),
            color: '',
            tipo: '',
            imagen: null,
            estado: 'Disponible'
          });
          const vehicleFormSubmitted = ref(false);
          const assignmentFormSubmitted = ref(false);
          const userFormSubmitted = ref(false);
          
          // Métodos
          const login = async () => {
            isLoading.value = true;
            try {
              // Simular petición a API
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              // Updated login credentials and roles
              if (loginForm.value.email === 'globaladmin@ejemplo.com' && loginForm.value.password === 'Admin123!') {
                currentUser.value = {
                  id: 1,
                  nombre: 'Admin',
                  apellido: 'Global',
                  email: 'globaladmin@ejemplo.com',
                  telefono: '555-1234',
                  rol: 'Administrador Global',
                  foto: 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png'
                };
                isAuthenticated.value = true;
                loadData();
                initWebSocket(); // Initialize WebSocket after authentication
              } else if (loginForm.value.email === 'admin@ejemplo.com' && loginForm.value.password === 'Admin123!') {
                currentUser.value = {
                  id: 2,
                  nombre: 'Admin',
                  apellido: 'Normal',
                  email: 'admin@ejemplo.com',
                  telefono: '555-5678',
                  rol: 'Administrador',
                  foto: 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png'
                };
                isAuthenticated.value = true;
                loadData();
              } else if (loginForm.value.email === 'usuario@ejemplo.com' && loginForm.value.password === 'User123!') {
                currentUser.value = {
                  id: 3,
                  nombre: 'Usuario',
                  apellido: 'Normal',
                  email: 'usuario@ejemplo.com',
                  telefono: '555-5678',
                  rol: 'Usuario',
                  foto: 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png'
                };
                isAuthenticated.value = true;
                loadData();
              } else {
                loginError.value = 'Credenciales incorrectas';
              }
            } catch (error) {
              loginError.value = 'Error al iniciar sesión';
            } finally {
              isLoading.value = false;
            }
          };
          
          const logout = () => {
            isAuthenticated.value = false;
            currentUser.value = {};
            
            // Close WebSocket connection
            if (socket) {
              socket.close();
              socket = null;
            }
          };
          
          const setCurrentRoute = (route) => {
            // Check if user has permission to access the route
            if (!isAdmin.value && ['asignaciones', 'mapa', 'usuarios', 'dashboard'].includes(route)) {
              alert('No tienes permisos para acceder a esta sección');
              return;
            }
            currentRoute.value = route;
            if (route === 'mapa' && !map) {
              // Inicializar mapa cuando navegamos a esa ruta
              setTimeout(() => {
                initMap();
              }, 100);
            }
          };
          
          const loadData = async () => {
            // Cargar datos de ejemplo
            vehiculos.value = generateVehicles();
            asignaciones.value = generateAssignments();
            usuarios.value = generateUsers();
            dashboardData.value = generateDashboardData();
            
            // Inicializar formulario de perfil
            profileForm.value = {
              nombre: currentUser.value.nombre,
              apellido: currentUser.value.apellido,
              email: currentUser.value.email,
              telefono: currentUser.value.telefono,
              currentPassword: '',
              newPassword: ''
            };
          };
          
          const initMap = () => {
            if (map) return;
            
            // Coordenadas de Guadalajara, Jalisco
            const guadalajara = [20.6597, -103.3496];
            
            map = L.map('map').setView(guadalajara, 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add markers based on user role
            addVehicleMarkers();
            
            // Set up real-time updates
            setInterval(() => {
              updateVehicleLocations();
            }, 30000); // Update every 30 seconds
          };
          
          const addVehicleMarkers = () => {
            if (!map) return;
            
            // Clear existing markers
            if (vehicleMarkers) {
              vehicleMarkers.forEach(marker => map.removeLayer(marker));
            }
            vehicleMarkers = [];
            
            // Add markers based on user role
            const vehiclesToShow = isGlobalAdmin.value ? 
              vehiculos.value : 
              vehiculos.value.filter(v => v.estado === 'Asignado' && v.usuario === `${currentUser.value.nombre} ${currentUser.value.apellido}`);
            
            vehiclesToShow.forEach(vehiculo => {
              // Use stored coordinates or generate random ones if not available
              const lat = vehiculo.lat || (20.6597 + (Math.random() - 0.5) * 0.1);
              const lng = vehiculo.lng || (-103.3496 + (Math.random() - 0.5) * 0.1);
              
              // Store coordinates if not already stored
              if (!vehiculo.lat) {
                vehiculo.lat = lat;
                vehiculo.lng = lng;
              }
              
              const marker = L.marker([lat, lng]).addTo(map);
              marker.bindPopup(`
                <strong>${vehiculo.marca} ${vehiculo.modelo}</strong><br>
                Matrícula: ${vehiculo.matricula}<br>
                Estado: ${vehiculo.estado}
                ${vehiculo.usuario ? `<br>Asignado a: ${vehiculo.usuario}` : ''}
                <br><br>
                <button class="btn btn-sm btn-primary update-location" data-vehicle-id="${vehiculo.id}">
                  Actualizar ubicación
                </button>
              `);
              
              marker.on('popupopen', () => {
                setTimeout(() => {
                  const updateBtn = document.querySelector(`.update-location[data-vehicle-id="${vehiculo.id}"]`);
                  if (updateBtn) {
                    updateBtn.addEventListener('click', () => updateVehicleLocation(vehiculo));
                  }
                }, 100);
              });
              
              vehicleMarkers.push(marker);
            });
          };
          
          const updateVehicleLocations = async () => {
            try {
              // Simulate API call to update locations
              console.log('Updating vehicle locations...');
              
              // In a real application, this would be an API call to a GPS service
              vehiculos.value.forEach(vehiculo => {
                // Small random movement to simulate GPS updates
                if (vehiculo.lat && vehiculo.lng) {
                  vehiculo.lat += (Math.random() - 0.5) * 0.005;
                  vehiculo.lng += (Math.random() - 0.5) * 0.005;
                }
              });
              
              // Refresh markers
              addVehicleMarkers();
            } catch (error) {
              console.error('Error updating vehicle locations:', error);
            }
          };
          
          const updateVehicleLocation = async (vehiculo) => {
            try {
              isLoading.value = true;
              
              // Simulate API call to update location in PostgreSQL
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              // Update with new coordinates (in real app, these would come from GPS API)
              vehiculo.lat = 20.6597 + (Math.random() - 0.5) * 0.1;
              vehiculo.lng = -103.3496 + (Math.random() - 0.5) * 0.1;
              
              addVehicleMarkers();
              
              alert(`Ubicación de vehículo ${vehiculo.matricula} actualizada correctamente`);
            } catch (error) {
              console.error('Error updating vehicle location:', error);
              alert('Error al actualizar la ubicación');
            } finally {
              isLoading.value = false;
            }
          };
          
          const openVehicleModal = (vehiculo) => {
            selectedVehicle.value = vehiculo;
            if (vehicleDetailModal) {
              vehicleDetailModal.show();
            } else {
              console.error('vehicleDetailModal no está inicializado');
              // Try to initialize modal if it wasn't initialized during mounting
              const vehicleDetailEl = document.getElementById('vehicleDetailModal');
              if (vehicleDetailEl) {
                vehicleDetailModal = new bootstrap.Modal(vehicleDetailEl);
                vehicleDetailModal.show();
              }
            }
          };
          
          const openNewVehicleModal = () => {
            vehicleFormSubmitted.value = false;
            vehicleForm.value = {
              id: null,
              matricula: '',
              marca: '',
              modelo: '',
              anio: new Date().getFullYear(),
              color: '',
              tipo: '',
              imagen: null,
              estado: 'Disponible'
            };
            if (newVehicleModal) {
              newVehicleModal.show();
            } else {
              console.error('newVehicleModal is not initialized');
              const newVehicleModalEl = document.getElementById('newVehicleModal');
              if (newVehicleModalEl) {
                newVehicleModal = new bootstrap.Modal(newVehicleModalEl);
                newVehicleModal.show();
              }
            }
          };
          
          const handleVehicleImageUpload = (event) => {
            console.log('Image upload event triggered');
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                vehicleForm.value.imagen = e.target.result;
                console.log('Image loaded successfully');
              };
              reader.readAsDataURL(file);
            }
          };
          
          const saveVehicle = async () => {
            console.log('saveVehicle function called'); // Debug log
            vehicleFormSubmitted.value = true;
            // Validate form - remove !vehicleForm.value.imagen from required fields
            if (!vehicleForm.value.matricula || 
                !vehicleForm.value.marca || 
                !vehicleForm.value.modelo || 
                !vehicleForm.value.anio || 
                vehicleForm.value.anio > 2025 ||
                !vehicleForm.value.color || 
                !vehicleForm.value.tipo) {
              alert('Por favor complete todos los campos correctamente');
              return;
            }
            isLoading.value = true;
            try {
              // Simulate API call
              await new Promise(resolve => setTimeout(resolve, 1000));
              // Create new vehicle object - provide default image if none provided
              const newVehicle = {
                id: vehiculos.value.length + 1,
                matricula: vehicleForm.value.matricula,
                marca: vehicleForm.value.marca,
                modelo: vehicleForm.value.modelo,
                anio: vehicleForm.value.anio,
                color: vehicleForm.value.color,
                tipo: vehicleForm.value.tipo,
                imagen: vehicleForm.value.imagen || 'https://cdn.pixabay.com/photo/2016/02/13/13/11/oldtimer-1197800_960_720.jpg',
                estado: 'Disponible',
                actualizacion: new Date().toISOString().split('T')[0],
                imagenes: []
              };
              // Update local state
              vehiculos.value.push(newVehicle);
              // Send update through WebSocket
              sendWebSocketUpdate('VEHICLE_UPDATE', newVehicle);
              if (newVehicleModal) {
                newVehicleModal.hide();
              }
              // Show confirmation message instead of alert
              confirmationMessage.value = 'Vehículo creado exitosamente';
              confirmationType.value = 'success';
              showConfirmation.value = true;
              setTimeout(() => { showConfirmation.value = false; }, 3000);
            } catch (error) {
              console.error('Error al crear vehículo:', error);
              // Show error message
              confirmationMessage.value = 'Error al crear el vehículo';
              confirmationType.value = 'danger';
              showConfirmation.value = true;
              setTimeout(() => { showConfirmation.value = false; }, 3000);
            } finally {
              isLoading.value = false;
            }
          };
          
          const openNewAssignmentModal = () => {
            assignmentFormSubmitted.value = false;
            newAssignment.value = {
              vehiculoId: '',
              usuarioId: '',
              fecha: new Date().toISOString().split('T')[0]
            };
            if (newAssignmentModal) {
              newAssignmentModal.show();
            } else {
              console.error('newAssignmentModal is not initialized');
              const newAssignmentEl = document.getElementById('newAssignmentModal');
              if (newAssignmentEl) {
                newAssignmentModal = new bootstrap.Modal(newAssignmentEl);
                newAssignmentModal.show();
              }
            }
          };
          
          const createAssignment = async () => {
            console.log('createAssignment function called'); // Debug log
            assignmentFormSubmitted.value = true;
            // Validations
            if (!newAssignment.value.vehiculoId || !newAssignment.value.usuarioId || !newAssignment.value.fecha) {
              return;
            }
            isLoading.value = true;
            try {
              // Simular petición a API
              await new Promise(resolve => setTimeout(resolve, 1000));
              const vehiculo = vehiculos.value.find(v => v.id === newAssignment.value.vehiculoId);
              const usuario = usuarios.value.find(u => u.id === newAssignment.value.usuarioId);
              if (vehiculo && usuario) {
                const newAssignmentData = {
                  id: asignaciones.value.length + 1,
                  vehiculoId: vehiculo.id,
                  usuarioId: usuario.id,
                  usuario: `${usuario.nombre} ${usuario.apellido}`,
                  vehiculo: `${vehiculo.marca} ${vehiculo.modelo}`,
                  matricula: vehiculo.matricula,
                  fecha: newAssignment.value.fecha
                };
                // Update local state immediately for better UX
                asignaciones.value.push(newAssignmentData);
                // Update vehicle status
                vehiculo.estado = 'Asignado';
                vehiculo.usuario = `${usuario.nombre} ${usuario.apellido}`;
                // Send update through WebSocket
                sendWebSocketUpdate('ASSIGNMENT_UPDATE', { 
                  action: 'CREATE', 
                  assignment: newAssignmentData 
                });
                if (newAssignmentModal) {
                  newAssignmentModal.hide();
                }
                // Replace alert with confirmation message
                confirmationMessage.value = 'Asignación creada exitosamente';
                confirmationType.value = 'success';
                showConfirmation.value = true;
                setTimeout(() => { showConfirmation.value = false; }, 3000);
              }
            } catch (error) {
              console.error('Error al crear asignación:', error);
              // Show error message
              confirmationMessage.value = 'Error al crear la asignación';
              confirmationType.value = 'danger';
              showConfirmation.value = true;
              setTimeout(() => { showConfirmation.value = false; }, 3000);
            } finally {
              isLoading.value = false;
            }
          };
          
          const deleteAssignment = async (id) => {
            if (!confirm('¿Está seguro de eliminar esta asignación?')) return;
            
            isLoading.value = true;
            try {
              // Simular petición a API
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              const asignacion = asignaciones.value.find(a => a.id === id);
              if (asignacion) {
                // Update local state immediately for better UX
                asignaciones.value = asignaciones.value.filter(a => a.id !== id);
                
                // Update vehicle status
                const vehiculo = vehiculos.value.find(v => v.matricula === asignacion.matricula);
                if (vehiculo) {
                  vehiculo.estado = 'Disponible';
                  vehiculo.usuario = null;
                }
                
                // Send update through WebSocket
                sendWebSocketUpdate('ASSIGNMENT_UPDATE', { 
                  action: 'DELETE', 
                  assignmentId: id,
                  matricula: asignacion.matricula 
                });
              }
            } catch (error) {
              console.error('Error al eliminar asignación:', error);
              alert('Error al eliminar la asignación');
            } finally {
              isLoading.value = false;
            }
          };
          
          const openNewUserModal = () => {
            userFormSubmitted.value = false;
            isEditingUser.value = false;
            userForm.value = {
              id: null,
              nombre: '',
              apellido: '',
              email: '',
              telefono: '',
              rol: 'Usuario',
              password: ''
            };
            if (userModal) {
              userModal.show();
            } else {
              console.error('userModal is not initialized');
              const userModalEl = document.getElementById('userModal');
              if (userModalEl) {
                userModal = new bootstrap.Modal(userModalEl);
                userModal.show();
              }
            }
          };
          
          const editUser = (usuario) => {
            userFormSubmitted.value = false;
            isEditingUser.value = true;
            userForm.value = {
              id: usuario.id,
              nombre: usuario.nombre,
              apellido: usuario.apellido,
              email: usuario.email,
              telefono: usuario.telefono,
              rol: usuario.rol,
              password: ''
            };
            if (userModal) {
              userModal.show();
            } else {
              console.error('userModal is not initialized');
              const userModalEl = document.getElementById('userModal');
              if (userModalEl) {
                userModal = new bootstrap.Modal(userModalEl);
                userModal.show();
              }
            }
          };
          
          const saveUser = async () => {
            console.log('saveUser function called'); // Debug log
            userFormSubmitted.value = true;
            // Validate required fields
            if (!userForm.value.nombre || !userForm.value.apellido || 
                !userForm.value.email || !userForm.value.telefono || 
                !userForm.value.rol) {
              return;
            }
            // Validate password for new users
            if (!isEditingUser.value && (!userForm.value.password || !isValidUserPassword.value)) {
              return;
            }
            isLoading.value = true;
            try {
              // Simular petición a API
              await new Promise(resolve => setTimeout(resolve, 1000));
              if (isEditingUser.value) {
                // Prepare user data based on role permissions
                let userData = {...userForm.value};
                // If not Global Admin, restrict fields that can be updated
                if (currentUser.value.rol !== 'Administrador Global') {
                  const existingUser = usuarios.value.find(u => u.id === userData.id);
                  if (existingUser) {
                    // Keep original values for fields that can't be changed
                    userData.email = existingUser.email;
                    userData.rol = existingUser.rol;
                  }
                }
                // Update local state immediately
                const index = usuarios.value.findIndex(u => u.id === userData.id);
                if (index !== -1) {
                  usuarios.value[index] = {...usuarios.value[index], ...userData};
                  // Update current user if it's the same
                  if (currentUser.value.id === userData.id) {
                    currentUser.value = { ...currentUser.value, ...userData };
                  }
                }
                // Send update through WebSocket
                sendWebSocketUpdate('USER_UPDATE', { 
                  action: 'UPDATE', 
                  user: userData 
                });
                alert('Usuario actualizado exitosamente');
              } else {
                // Create new user
                const newUser = {
                  id: usuarios.value.length + 1,
                  nombre: userForm.value.nombre,
                  apellido: userForm.value.apellido,
                  email: userForm.value.email,
                  telefono: userForm.value.telefono,
                  rol: userForm.value.rol
                };
                // Update local state immediately
                usuarios.value.push(newUser);
                // Send update through WebSocket
                sendWebSocketUpdate('USER_UPDATE', { 
                  action: 'CREATE', 
                  user: newUser 
                });
                alert('Usuario creado exitosamente');
              }
              if (userModal) {
                userModal.hide();
              } else {
                console.error('Cannot hide userModal: not initialized');
              }
            } catch (error) {
              console.error('Error al guardar usuario:', error);
              alert('Error al guardar el usuario');
            } finally {
              isLoading.value = false;
            }
          };
          
          const deleteUser = async (id) => {
            if (!confirm('¿Está seguro de eliminar este usuario?')) return;
            
            isLoading.value = true;
            try {
              // Simular petición a API
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              // Send update through WebSocket
              sendWebSocketUpdate('USER_UPDATE', { 
                action: 'DELETE', 
                userId: id 
              });
              
              // No need to update local state as it will be updated by the WebSocket handler
            } catch (error) {
              console.error('Error al eliminar usuario:', error);
            } finally {
              isLoading.value = false;
            }
          };
          
          const updateProfile = async () => {
            isUpdating.value = true;
            try {
              // Validar contraseña si se está cambiando
              if (profileForm.value.newPassword && !isValidPassword.value) {
                alert('La nueva contraseña no cumple con los requisitos de seguridad');
                return;
              }
              
              // Simular petición a API
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              // Prepare user data for update
              const userData = {
                id: currentUser.value.id,
                nombre: profileForm.value.nombre,
                apellido: profileForm.value.apellido,
                telefono: profileForm.value.telefono
                // Email can't be changed by users
              };
              
              // Send update through WebSocket
              sendWebSocketUpdate('USER_UPDATE', { 
                action: 'UPDATE', 
                user: userData 
              });
              
              // Limpiar campos de contraseña
              profileForm.value.currentPassword = '';
              profileForm.value.newPassword = '';
              
              alert('Perfil actualizado con éxito');
            } catch (error) {
              console.error('Error al actualizar perfil:', error);
              alert('Error al actualizar perfil');
            } finally {
              isUpdating.value = false;
            }
          };
          
          const updateProfilePhoto = () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = async (e) => {
              if (e.target.files.length > 0) {
                isUpdating.value = true;
                try {
                  const file = e.target.files[0];
                  
                  // Simulate uploading to server
                  await new Promise(resolve => setTimeout(resolve, 1500));
                  
                  // Create a URL for the selected image
                  const reader = new FileReader();
                  reader.onload = (event) => {
                    // Update profile photo
                    currentUser.value.foto = event.target.result;
                    alert('Foto de perfil actualizada correctamente');
                    isUpdating.value = false;
                  };
                  reader.readAsDataURL(file);
                } catch (error) {
                  console.error('Error updating profile photo:', error);
                  alert('Error al actualizar la foto de perfil');
                  isUpdating.value = false;
                }
              }
            };
            
            fileInput.click();
          };
          
          const getRoleBadgeClass = (rol) => {
            switch (rol) {
              case 'Administrador Global':
                return 'bg-danger';
              case 'Administrador':
                return 'bg-warning';
              default:
                return 'bg-info';
            }
          };
          
          // WebSocket implementation with mock functionality for demo purposes
          const initWebSocket = () => {
            console.log('Initializing WebSocket connection');
            
            try {
              // Create a mock WebSocket that simulates the real behavior
              socket = {
                readyState: 1, // WebSocket.OPEN
                send: function(message) {
                  console.log('WebSocket message sent:', message);
                  // Simulate receiving the same message back after processing
                  setTimeout(() => {
                    if (this.onmessage) {
                      this.onmessage({ data: message });
                    }
                  }, 200);
                },
                onopen: null,
                onmessage: null,
                onclose: null,
                onerror: null,
                close: function() {
                  console.log('WebSocket connection closed');
                  this.readyState = 3; // WebSocket.CLOSED
                  if (this.onclose) this.onclose();
                }
              };
              
              // Set handlers
              socket.onopen = () => {
                console.log('Mock WebSocket connection established');
              };
              
              socket.onmessage = (event) => {
                try {
                  const data = JSON.parse(event.data);
                  console.log('WebSocket message received:', data);
                  
                  // Handle different types of updates
                  switch (data.type) {
                    case 'VEHICLE_UPDATE':
                      handleVehicleUpdate(data.payload);
                      break;
                    case 'ASSIGNMENT_UPDATE':
                      handleAssignmentUpdate(data.payload);
                      break;
                    case 'USER_UPDATE':
                      handleUserUpdate(data.payload);
                      break;
                    case 'LOCATION_UPDATE':
                      handleLocationUpdate(data.payload);
                      break;
                    default:
                      console.log('Unknown update type:', data.type);
                  }
                } catch (error) {
                  console.error('Error processing WebSocket message:', error);
                }
              };
              
              // Simulate an open event
              if (socket.onopen) {
                socket.onopen();
              }
            } catch (error) {
              console.error('Error initializing WebSocket:', error);
            }
          };
          
          // WebSocket message handlers
          const handleVehicleUpdate = (vehicle) => {
            const index = vehiculos.value.findIndex(v => v.id === vehicle.id);
            if (index !== -1) {
              vehiculos.value[index] = vehicle;
            } else {
              vehiculos.value.push(vehicle);
            }
            
            // If map is initialized, update markers
            if (map) {
              addVehicleMarkers();
            }
            
            // Update dashboard data
            if (isGlobalAdmin.value) {
              dashboardData.value = generateDashboardData();
            }
          };
          
          const handleAssignmentUpdate = (data) => {
            if (data.action === 'CREATE') {
              // Check if the assignment already exists to avoid duplicates
              const existingIndex = asignaciones.value.findIndex(a => a.id === data.assignment.id);
              if (existingIndex === -1) {
                asignaciones.value.push(data.assignment);
              }
              
              // Update vehicle status
              const vehiculo = vehiculos.value.find(v => v.id === data.assignment.vehiculoId);
              if (vehiculo) {
                vehiculo.estado = 'Asignado';
                vehiculo.usuario = data.assignment.usuario;
              }
            } else if (data.action === 'DELETE') {
              asignaciones.value = asignaciones.value.filter(a => a.id !== data.assignmentId);
              
              // Update vehicle status
              const vehiculo = vehiculos.value.find(v => v.matricula === data.matricula);
              if (vehiculo) {
                vehiculo.estado = 'Disponible';
                vehiculo.usuario = null;
              }
            }
            
            // Update dashboard data if applicable
            if (isGlobalAdmin.value) {
              dashboardData.value = generateDashboardData();
            }
          };
          
          const handleUserUpdate = (data) => {
            if (data.action === 'CREATE') {
              usuarios.value.push(data.user);
            } else if (data.action === 'UPDATE') {
              const index = usuarios.value.findIndex(u => u.id === data.user.id);
              if (index !== -1) {
                usuarios.value[index] = data.user;
                
                // Update current user if it's the same
                if (currentUser.value.id === data.user.id) {
                  currentUser.value = { ...currentUser.value, ...data.user };
                }
              }
            } else if (data.action === 'DELETE') {
              usuarios.value = usuarios.value.filter(u => u.id !== data.userId);
            }
          };
          
          const handleLocationUpdate = (data) => {
            const vehiculo = vehiculos.value.find(v => v.id === data.vehiculoId);
            if (vehiculo) {
              vehiculo.lat = data.lat;
              vehiculo.lng = data.lng;
              
              // Update map if it's initialized
              if (map) {
                addVehicleMarkers();
              }
            }
          };
          
          // Send updates through WebSocket
          const sendWebSocketUpdate = (type, payload) => {
            if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(JSON.stringify({ type, payload }));
            } else {
              console.error('WebSocket is not connected');
            }
          };
          
          // Datos de ejemplo
          const generateVehicles = () => {
            const marcas = ['Toyota', 'Honda', 'Nissan', 'Ford', 'Chevrolet'];
            const modelos = {
              'Toyota': ['Corolla', 'Camry', 'RAV4', 'Hilux', 'Yaris'],
              'Honda': ['Civic', 'Accord', 'CR-V', 'HR-V', 'Pilot'],
              'Nissan': ['Sentra', 'Altima', 'Versa', 'X-Trail', 'Kicks'],
              'Ford': ['Focus', 'Escape', 'Explorer', 'Ranger', 'F-150'],
              'Chevrolet': ['Spark', 'Aveo', 'Cruze', 'Equinox', 'Silverado']
            };
            const colores = ['Blanco', 'Negro', 'Rojo', 'Azul', 'Plata', 'Gris'];
            const vehiculos = [];
            
            for (let i = 1; i <= 25; i++) {
              const marca = marcas[Math.floor(Math.random() * marcas.length)];
              const modelo = modelos[marca][Math.floor(Math.random() * modelos[marca].length)];
              const anio = 2018 + Math.floor(Math.random() * 5);
              const color = colores[Math.floor(Math.random() * colores.length)];
              const estado = Math.random() > 0.6 ? 'Disponible' : 'Asignado';
              let usuario = null;
              
              if (estado === 'Asignado') {
                if (Math.random() > 0.5) {
                  usuario = 'Admin Sistema';
                } else {
                  usuario = 'Usuario Normal';
                }
              }
              
              vehiculos.push({
                id: i,
                marca,
                modelo,
                anio,
                color,
                matricula: `ABC-${1000 + i}`,
                estado,
                usuario,
                imagen: `https://cdn.pixabay.com/photo/2016/02/13/13/11/oldtimer-1197800_960_720.jpg`,
                imagenes: [
                  'https://cdn.pixabay.com/photo/2015/05/28/23/12/auto-788747_960_720.jpg',
                  'https://cdn.pixabay.com/photo/2013/07/12/12/56/car-146185_960_720.png',
                  'https://cdn.pixabay.com/photo/2014/09/07/22/34/car-race-438467_960_720.jpg'
                ],
                actualizacion: '2023-05-15'
              });
            }
            
            return vehiculos;
          };
          
          const generateAssignments = () => {
            const asignaciones = [];
            const vehiculosAsignados = vehiculos.value.filter(v => v.estado === 'Asignado');
            
            vehiculosAsignados.forEach((vehiculo, index) => {
              asignaciones.push({
                id: index + 1,
                usuario: vehiculo.usuario,
                vehiculo: `${vehiculo.marca} ${vehiculo.modelo}`,
                matricula: vehiculo.matricula,
                fecha: '2023-01-15'
              });
            });
            
            return asignaciones;
          };
          
          const generateUsers = () => {
            return [
              {
                id: 1,
                nombre: 'Admin',
                apellido: 'Global',
                email: 'globaladmin@ejemplo.com',
                telefono: '555-1234',
                rol: 'Administrador Global'
              },
              {
                id: 2,
                nombre: 'Admin',
                apellido: 'Normal',
                email: 'admin@ejemplo.com',
                telefono: '555-5678',
                rol: 'Administrador'
              },
              {
                id: 3,
                nombre: 'Usuario',
                apellido: 'Normal',
                email: 'usuario@ejemplo.com',
                telefono: '555-5678',
                rol: 'Usuario'
              },
              {
                id: 4,
                nombre: 'María',
                apellido: 'González',
                email: 'maria@ejemplo.com',
                telefono: '555-3456',
                rol: 'Administrador'
              }
            ];
          };
          
          const generateDashboardData = () => {
            const marcas = {};
            
            // Agrupar vehículos por marca y estado
            vehiculos.value.forEach(vehiculo => {
              if (!marcas[vehiculo.marca]) {
                marcas[vehiculo.marca] = {
                  nombre: vehiculo.marca,
                  disponibles: 0,
                  asignados: 0
                };
              }
              
              if (vehiculo.estado === 'Disponible') {
                marcas[vehiculo.marca].disponibles++;
              } else {
                marcas[vehiculo.marca].asignados++;
              }
            });
            
            return Object.values(marcas);
          };
          
          // Hooks del ciclo de vida
          onMounted(() => {
            // Inicializar modales de Bootstrap
            setTimeout(() => {
              const vehicleDetailEl = document.getElementById('vehicleDetailModal');
              if (vehicleDetailEl) {
                vehicleDetailModal = new bootstrap.Modal(vehicleDetailEl);
              } else {
                console.error('Modal element vehicleDetailModal not found in DOM');
              }
              
              const newAssignmentEl = document.getElementById('newAssignmentModal');
              if (newAssignmentEl) {
                newAssignmentModal = new bootstrap.Modal(newAssignmentEl);
                // Ensure event listener is attached to save button
                const saveAssignmentBtn = newAssignmentEl.querySelector('.btn-primary');
                if (saveAssignmentBtn) {
                  saveAssignmentBtn.addEventListener('click', createAssignment);
                }
              } else {
                console.error('Modal element newAssignmentModal not found in DOM');
              }
              
              const userModalEl = document.getElementById('userModal');
              if (userModalEl) {
                userModal = new bootstrap.Modal(userModalEl);
                // Ensure event listener is attached to save button
                const saveUserBtn = userModalEl.querySelector('.btn-primary');
                if (saveUserBtn) {
                  saveUserBtn.addEventListener('click', saveUser);
                }
              } else {
                console.error('Modal element userModal not found in DOM');
              }
              
              const newVehicleModalEl = document.getElementById('newVehicleModal');
              if (newVehicleModalEl) {
                newVehicleModal = new bootstrap.Modal(newVehicleModalEl);
                // Ensure event listener is attached to save button
                const saveVehicleBtn = newVehicleModalEl.querySelector('.btn-primary');
                if (saveVehicleBtn) {
                  saveVehicleBtn.addEventListener('click', saveVehicle);
                }
              } else {
                console.error('Modal element newVehicleModal not found in DOM');
              }
            }, 500);  // Add a small delay to ensure DOM is ready
          });
          
          // Add new computed property for filtered vehicles
          const filteredVehiculos = computed(() => {
            if (isAdmin.value) {
              return vehiculos.value;
            } else {
              // For regular users, only show vehicles assigned to them
              return vehiculos.value.filter(v => 
                v.usuario === `${currentUser.value.nombre} ${currentUser.value.apellido}` || 
                v.usuario === currentUser.value.nombre
              );
            }
          });
          
          // Add new variables
          const showConfirmation = ref(false);
          const confirmationMessage = ref('');
          const confirmationType = ref('success'); // Can be 'success', 'error', etc.
          
          return {
            // Estado
            isAuthenticated,
            currentUser,
            loginForm,
            loginError,
            isLoading,
            isUpdating,
            currentRoute,
            profileForm,
            userForm,
            newAssignment,
            vehiculos,
            asignaciones,
            usuarios,
            dashboardData,
            selectedVehicle,
            isEditingUser,
            
            // Computados
            isAdmin,
            isGlobalAdmin,
            vehiculosDisponibles,
            passwordHasUppercase,
            passwordHasLowercase,
            passwordHasNumber,
            passwordHasSpecial,
            passwordHasMinLength,
            isValidPassword,
            userPasswordHasUppercase,
            userPasswordHasLowercase,
            userPasswordHasNumber,
            userPasswordHasSpecial,
            userPasswordHasMinLength,
            isValidUserPassword,
            filteredVehiculos,
            
            // Métodos
            login,
            logout,
            setCurrentRoute,
            openVehicleModal,
            openNewVehicleModal,
            handleVehicleImageUpload,
            saveVehicle,
            openNewAssignmentModal,
            createAssignment,
            deleteAssignment,
            openNewUserModal,
            editUser,
            saveUser,
            deleteUser,
            updateProfile,
            updateProfilePhoto,
            getRoleBadgeClass,
            showConfirmation,
            confirmationMessage,
            confirmationType
          };
        }
      });
      
      // Add global error handler for Vue app
      app.config.errorHandler = (err, vm, info) => {
        console.error('Vue Error:', err);
        console.log('Error Info:', info);
        // You could also send errors to a logging service here
      };
      
      // Mount the app with error handling
      try {
        app.mount('#app');
      } catch (err) {
        console.error('Error mounting Vue application:', err);
      }
    } catch (err) {
      console.error('Fatal error during application initialization:', err);
      // Display a user-friendly error message
      document.getElementById('app').innerHTML = '<div class="alert alert-danger m-5">Lo sentimos, ha ocurrido un error inesperado. Por favor, actualice la página o contacte al soporte técnico.</div>';
    }
  </script>
</body>
</html>
